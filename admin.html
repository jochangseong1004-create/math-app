<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëª¨ë“œ - ì¡°ì°½ì„±T</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --admin-dark: #1e1e2e; --admin-accent: #7d5fff; --text-white: #f8f9fa; }
        body { font-family: "Pretendard Variable", sans-serif; background-color: var(--admin-dark); color: var(--text-white); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h2 { text-align: center; margin-bottom: 30px; color: var(--admin-accent); }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        input { padding: 15px; border-radius: 10px; border: none; width: 250px; margin-bottom: 10px; font-size: 16px; }
        button { padding: 15px 30px; border-radius: 10px; border: none; background: var(--admin-accent); color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        button:hover { opacity: 0.9; }
        #dashboard-screen { display: none; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { flex: 1; padding: 15px; background: #313244; color: #a6adc8; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; }
        .nav-btn.active { background: var(--admin-accent); color: white; font-weight: bold; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        select { padding: 12px; border-radius: 8px; border: none; font-size: 16px; flex: 1; min-width: 150px; }
        
        .btn-capture { background-color: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-capture:hover { background-color: #27ae60; }
        
        /* í”¼ë“œë°± ë³µì‚¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-feedback { background-color: #e67e22; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-feedback:hover { background-color: #d35400; }

        .filter-group { display: flex; gap: 5px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 12px; border-radius: 20px; border: 1px solid #585b70; background: transparent; color: #cdd6f4; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 4px; transition: 0.2s; }
        .filter-btn.active { background: white; color: var(--admin-dark); border-color: white; font-weight: bold; }
        .filter-btn.active .dot { border: 1px solid rgba(0,0,0,0.1); }
        .dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; }
        .s-0 { background: #585b70; } .s-1 { background: #a6e3a1; } .s-2 { background: #f38ba8; } .s-3 { background: #89b4fa; } 
        .report-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .report-card { background: #313244; padding: 20px; border-radius: 15px; border: 1px solid #45475a; }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 18px; color: var(--admin-accent); }
        .item-list { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .item { padding: 4px 10px; border-radius: 6px; font-size: 13px; font-weight: bold; color: #1e1e2e; }
        .item-0 { background: #585b70; color: white; } .item-1 { background: #a6e3a1; } .item-2 { background: #f38ba8; } .item-3 { background: #89b4fa; }
        #capture-area { background: #1e1e2e; padding: 20px; border-radius: 15px; }
        #capture-header { display: none; text-align: center; margin-bottom: 20px; color: var(--text-white); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--admin-accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸ‘¨â€ğŸ« ì¡°ì°½ì„±T ê´€ë¦¬ì ëª¨ë“œ</h2>
    <div id="login-screen">
        <input type="password" id="admin-pw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
        <button onclick="adminLogin()">ì ‘ì†í•˜ê¸° (ë°ì´í„° ë¡œë”©)</button>
    </div>
    <div id="dashboard-screen">
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('chapter')">ğŸ“š ë‹¨ì›ë³„ ë³´ê¸°</button>
            <button class="nav-btn" onclick="switchTab('student')">ğŸ“ í•™ìƒë³„ ë³´ê¸°</button>
        </div>
        <div id="loader" class="loader"></div>
        <div id="loading-msg" style="text-align:center; color:#a6adc8; display:none; margin-bottom:20px;">ëª¨ë“  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...<br>(ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)</div>

        <div class="controls">
            <select id="main-select" onchange="renderView()">
                <option value="">ì„ íƒí•˜ì„¸ìš”...</option>
            </select>
            <div class="filter-group">
                <button class="filter-btn active" id="btn-all" onclick="toggleFilter('all')">ì „ì²´</button>
                <button class="filter-btn active" id="btn-1" onclick="toggleFilter(1)"><span class="dot s-1"></span> ë§ìŒ</button>
                <button class="filter-btn active" id="btn-3" onclick="toggleFilter(3)"><span class="dot s-3"></span> ê³ ì¹¨</button>
                <button class="filter-btn active" id="btn-2" onclick="toggleFilter(2)"><span class="dot s-2"></span> í‹€ë¦¼</button>
                <button class="filter-btn active" id="btn-0" onclick="toggleFilter(0)"><span class="dot s-0"></span> ì•ˆí’ˆ</button>
            </div>
            <button id="btn-capture" class="btn-capture" style="display:none;" onclick="captureReport()">ğŸ“¸ ìº¡ì²˜ ì €ì¥</button>
            <button id="btn-feedback" class="btn-feedback" style="display:none;" onclick="generateFeedback()">ğŸ“ í”¼ë“œë°± ë³µì‚¬</button>
        </div>

        <div id="view-area">
             <div id="capture-area">
                <div id="capture-header">
                    <h3 style="margin:0; color:#7d5fff;">ğŸ“Š ì¡°ì°½ì„±T ìˆ˜í•™ ê³¼ì œ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
                    <p style="margin:5px 0; color:#a6adc8;" id="capture-title">ë¶„ì„ ë¦¬í¬íŠ¸</p>
                    <hr style="border:0; border-top:1px solid #45475a; margin:15px 0;">
                </div>
                <div id="report-container" class="report-grid"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec";
    const ADMIN_PW = "0602"; 
    let globalDB = { sheets: {}, students: [] };
    let currentMode = 'chapter'; 
    let activeFilters = [0, 1, 2, 3]; 

    function adminLogin() {
        const input = document.getElementById('admin-pw').value;
        if(input === ADMIN_PW) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-screen').style.display = 'block';
            initAdmin();
        } else { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
    }
    function initAdmin() {
        document.getElementById('loader').style.display = 'block';
        document.getElementById('loading-msg').style.display = 'block';
        fetch(GOOGLE_SCRIPT_URL + "?action=getAllData").then(res => res.json()).then(data => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('loading-msg').style.display = 'none';
            globalDB = data; updateSelectOptions();
        }).catch(err => { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + err); location.reload(); });
    }
    function switchTab(tab) {
        currentMode = tab;
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        const captureBtn = document.getElementById('btn-capture');
        const feedbackBtn = document.getElementById('btn-feedback');
        if(tab === 'chapter') {
            document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
            captureBtn.style.display = 'none'; feedbackBtn.style.display = 'none';
        } else {
            document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
            captureBtn.style.display = 'flex'; feedbackBtn.style.display = 'flex';
        }
        document.getElementById('main-select').value = "";
        document.getElementById('report-container').innerHTML = "";
        updateSelectOptions();
    }
    function updateSelectOptions() {
        const select = document.getElementById('main-select');
        select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”...</option>';
        let list = currentMode === 'chapter' ? Object.keys(globalDB.sheets) : globalDB.students;
        list.forEach(item => {
            let opt = document.createElement('option');
            opt.value = item; opt.innerText = item;
            select.appendChild(opt);
        });
    }
    function toggleFilter(val) {
        if (val === 'all') { activeFilters = [0, 1, 2, 3]; } 
        else {
            if (activeFilters.includes(val)) activeFilters = activeFilters.filter(v => v !== val);
            else activeFilters.push(val);
        }
        updateFilterUI(); renderView();
    }
    function updateFilterUI() {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        activeFilters.forEach(val => { const btn = document.getElementById('btn-' + val); if(btn) btn.classList.add('active'); });
        if ([0, 1, 2, 3].every(v => activeFilters.includes(v))) { document.getElementById('btn-all').classList.add('active'); }
    }
    function renderView() {
        const value = document.getElementById('main-select').value;
        const container = document.getElementById('report-container');
        container.innerHTML = "";
        if(!value) return;
        const titleText = currentMode === 'chapter' ? `${value} - ì „ì²´ í•™ìƒ ë¶„ì„` : `${value} í•™ìƒ - ê³¼ì œ ë¶„ì„ ë¦¬í¬íŠ¸`;
        document.getElementById('capture-title').innerText = titleText;

        if (currentMode === 'chapter') {
            const sheetData = globalDB.sheets[value];
            if (!sheetData) return;
            sheetData.forEach(student => { const card = createCard(student['ì´ë¦„'], student); if (card) container.innerHTML += card; });
        } else {
            const studentName = value;
            const sheetNames = Object.keys(globalDB.sheets);
            sheetNames.forEach(sheetName => {
                const sheetData = globalDB.sheets[sheetName];
                const studentData = sheetData.find(row => row['ì´ë¦„'] === studentName);
                if (studentData) { const card = createCard(sheetName, studentData); if (card) container.innerHTML += card; }
            });
        }
        if(container.innerHTML === "") container.innerHTML = "<p style='text-align:center; width:100%; color:#a6adc8;'>í•´ë‹¹ ì¡°ê±´ì˜ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    }
    function createCard(title, dataObj) {
        const keys = Object.keys(dataObj).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸');
        let total = keys.length; let correct = 0; let filteredItems = [];
        keys.forEach(k => {
            let val = parseInt(dataObj[k]) || 0;
            if(val === 1 || val === 3) correct++;
            if(activeFilters.includes(val)) { filteredItems.push({ num: k, val: val }); }
        });
        if (filteredItems.length === 0) return null;
        let percent = total === 0 ? 0 : Math.round((correct/total)*100);
        return `<div class="report-card"><div class="card-header"><span>${title}</span><span>${percent}%</span></div><div class="item-list">${filteredItems.map(item => `<span class="item item-${item.val}">${item.num}</span>`).join('')}</div></div>`;
    }
    function captureReport() {
        const captureArea = document.getElementById('capture-area');
        const header = document.getElementById('capture-header');
        if(!document.getElementById('main-select').value) { alert("ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }
        header.style.display = 'block';
        html2canvas(captureArea, { backgroundColor: "#1e1e2e", scale: 2 }).then(canvas => {
            header.style.display = 'none';
            const link = document.createElement('a');
            link.download = document.getElementById('main-select').value + '_ë¶„ì„ë¦¬í¬íŠ¸.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    // â˜…â˜…â˜… í”¼ë“œë°± ìƒì„± ê¸°ëŠ¥ â˜…â˜…â˜…
    function generateFeedback() {
        const name = document.getElementById('main-select').value;
        if(!name) { alert("í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        
        // ê°€ì¥ ìµœê·¼ ë‹¨ì› ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë§ˆì§€ë§‰ ì‹œíŠ¸ ê¸°ì¤€)
        const sheetNames = Object.keys(globalDB.sheets);
        const lastSheetName = sheetNames[sheetNames.length - 1]; // ì œì¼ ë§ˆì§€ë§‰ ì‹œíŠ¸ê°€ ìµœì‹ ì´ë¼ê³  ê°€ì •
        const sheetData = globalDB.sheets[lastSheetName];
        const studentData = sheetData.find(row => row['ì´ë¦„'] === name);
        
        if(!studentData) { alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

        // í†µê³„ ê³„ì‚°
        const keys = Object.keys(studentData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸');
        let total = keys.length;
        let correct = 0;
        let done = 0; // í‘¼ ë¬¸ì œ (1,2,3)
        let wrongList = [];
        
        keys.forEach(k => {
            let val = parseInt(studentData[k]) || 0;
            if(val !== 0) done++;
            if(val === 1 || val === 3) correct++;
            if(val === 2) wrongList.push(k);
        });

        let percent = total === 0 ? 0 : Math.round((correct/total)*100);
        let progress = total === 0 ? 0 : Math.round((done/total)*100);

        // ë“±ê¸‰ ì•„ì´ì½˜
        let tierIcon = "ğŸ›¡ï¸";
        if(percent >= 90) tierIcon = "ğŸ’";
        else if(percent >= 70) tierIcon = "ğŸ’ ";
        else if(percent >= 50) tierIcon = "ğŸ¥‡";

        let feedback = `[ì¡°ì°½ì„±T ìˆ˜í•™ ê³¼ì œ ë¦¬í¬íŠ¸]\n\n`;
        feedback += `ğŸ“Œ í•™ìƒ: ${name}\n`;
        feedback += `ğŸ“š ë‹¨ì›: ${lastSheetName}\n`;
        
        // CASE 1: ë¯¸ì œì¶œ (ì§„ë„ìœ¨ 20% ë¯¸ë§Œ)
        if (progress < 20) {
            feedback += `âš ï¸ ê²°ê³¼: ë¯¸ì œì¶œ (ì§„ë„ìœ¨ ${progress}%)\n\n`;
            feedback += `ğŸ“¢ ì„ ìƒë‹˜ ì½”ë©˜íŠ¸\n`;
            feedback += `í•´ë‹¹ ë‹¨ì›ì˜ ê³¼ì œ ì œì¶œì´ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n`;
            feedback += `ê³¼ì œê°€ ë°€ë¦¬ë©´ ìˆ˜ì—… ì´í•´ë„ì— ì˜í–¥ì´ í½ë‹ˆë‹¤. í•™ìƒì´ ì§‘ì—ì„œ ê³¼ì œë¥¼ ë§ˆë¬´ë¦¬í•  ìˆ˜ ìˆë„ë¡ ê°€ì •ì—ì„œë„ ì§€ë„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.`;
        } 
        // CASE 2: ë¯¸í¡ (ì •ë‹µë¥  50% ë¯¸ë§Œ)
        else if (percent < 50) {
            feedback += `âš ï¸ ê²°ê³¼: ì¬í•™ìŠµ ìš”ë§ (ì •ë‹µë¥  ${percent}%)\n\n`;
            feedback += `ğŸ“¢ ì„ ìƒë‹˜ ì½”ë©˜íŠ¸\n`;
            feedback += `ê³¼ì œë¥¼ ì œì¶œí–ˆìœ¼ë‚˜, ê°œë… ì´í•´ì— ë‹¤ì†Œ ì–´ë ¤ì›€ì„ ê²ªê³  ìˆìŠµë‹ˆë‹¤.\n`;
            feedback += `ë‹¨ìˆœ ë¬¸ì œ í’€ì´ë³´ë‹¤ ê°œë… ë³µìŠµì´ ì‹œê¸‰í•©ë‹ˆë‹¤. ìˆ˜ì—… ì‹œê°„ì— ë”°ë¡œ í™•ì¸í•˜ê² ìŠµë‹ˆë‹¤. ê²©ë ¤ ë¶€íƒë“œë¦½ë‹ˆë‹¤.`;
        } 
        // CASE 3: ìš°ìˆ˜ (ì •ìƒ)
        else {
            feedback += `ğŸ† ê²°ê³¼: ${tierIcon} ì •ë‹µë¥  ${percent}% ë‹¬ì„±\n\n`;
            feedback += `ğŸ“¢ ì„ ìƒë‹˜ ì½”ë©˜íŠ¸\n`;
            feedback += `ê³¼ì œ ìˆ˜í–‰ë„ê°€ ë§¤ìš° ìš°ìˆ˜í•©ë‹ˆë‹¤. `;
            if(wrongList.length > 0) {
                feedback += `í‹€ë¦° ë¬¸í•­(${wrongList.slice(0,3).join(', ')}ë²ˆ ë“±)ì€ ì˜¤ë‹µ ì •ë¦¬ë¥¼ í†µí•´ ì™„ë²½íˆ ë‚´ ê²ƒìœ¼ë¡œ ë§Œë“¤ë„ë¡ ì§€ë„í•˜ê² ìŠµë‹ˆë‹¤.`;
            } else {
                feedback += `ì™„ë²½í•˜ê²Œ ì´í•´í–ˆìŠµë‹ˆë‹¤. ì¹­ì°¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤!`;
            }
        }

        // í´ë¦½ë³´ë“œ ë³µì‚¬
        navigator.clipboard.writeText(feedback).then(() => {
            alert("ğŸ“ í”¼ë“œë°±ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´í†¡ë°©ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.");
        }).catch(err => {
            alert("ë³µì‚¬ ì‹¤íŒ¨ (ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì • í™•ì¸ í•„ìš”)");
            console.error(err);
        });
    }
</script>
</body>
</html>
