<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëª¨ë“œ - ì¡°ì°½ì„±T</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --admin-dark: #1e1e2e; --admin-accent: #7d5fff; --text-white: #f8f9fa; }
        body { font-family: "Pretendard Variable", sans-serif; background-color: var(--admin-dark); color: var(--text-white); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h2 { text-align: center; margin-bottom: 30px; color: var(--admin-accent); }
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80vh; }
        input, select { padding: 15px; border-radius: 10px; border: none; width: 250px; margin-bottom: 10px; font-size: 16px; }
        button { padding: 15px 30px; border-radius: 10px; border: none; background: var(--admin-accent); color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        button:hover { opacity: 0.9; }
        
        #dashboard-screen { display: none; }
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav-btn { flex: 1; padding: 15px; background: #313244; color: #a6adc8; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; }
        .nav-btn.active { background: var(--admin-accent); color: white; font-weight: bold; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .controls select { flex: 1; min-width: 150px; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-action { color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; font-size: 13px; }
        .btn-green { background-color: #2ecc71; } .btn-green:hover { background-color: #27ae60; }
        .btn-orange { background-color: #e67e22; } .btn-orange:hover { background-color: #d35400; }
        .btn-blue { background-color: #3498db; } .btn-blue:hover { background-color: #2980b9; }
        .btn-purple { background-color: #9b59b6; } .btn-purple:hover { background-color: #8e44ad; }
        .btn-red { background-color: #e74c3c; } .btn-red:hover { background-color: #c0392b; }
        .btn-telegram { background-color: #0088cc; } .btn-telegram:hover { background-color: #0077b5; }
        .btn-dark { background-color: #45475a; } .btn-dark:hover { background-color: #585b70; }

        /* í•„í„° ë²„íŠ¼ */
        .filter-group { display: flex; gap: 5px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 12px; border-radius: 20px; border: 1px solid #585b70; background: transparent; color: #cdd6f4; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 4px; transition: 0.2s; }
        .filter-btn.active { background: white; color: var(--admin-dark); border-color: white; font-weight: bold; }
        .filter-btn.active .dot { border: 1px solid rgba(0,0,0,0.1); }
        .dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; }
        .s-0 { background: #585b70; } .s-1 { background: #a6e3a1; } .s-2 { background: #f38ba8; } .s-3 { background: #89b4fa; } 

        /* ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        #comm-panel { display: none; background: #313244; padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #45475a; }
        .comm-group { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .comm-label { font-weight: bold; width: 80px; color: #a6adc8; }
        
        .report-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .report-card { background: #313244; padding: 20px; border-radius: 15px; border: 1px solid #45475a; }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 18px; color: var(--admin-accent); }
        .item-list { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .item { padding: 4px 10px; border-radius: 6px; font-size: 13px; font-weight: bold; color: #1e1e2e; }
        .item-0 { background: #585b70; color: white; } .item-1 { background: #a6e3a1; } .item-2 { background: #f38ba8; } .item-3 { background: #89b4fa; }
        
        #capture-area { background: #1e1e2e; padding: 20px; border-radius: 15px; }
        #capture-header { display: none; text-align: center; margin-bottom: 20px; color: var(--text-white); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--admin-accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background-color: #313244; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 15px; color: white; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: white; }
        #chart-container { background: white; border-radius: 10px; padding: 15px; margin-top: 10px; position: relative; height: 350px; }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸ‘¨â€ğŸ« ì¡°ì°½ì„±T ê´€ë¦¬ì ëª¨ë“œ</h2>
    <div id="login-screen">
        <select id="admin-class-select"><option value="" disabled selected>ìˆ˜ì—… ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</option></select>
        <input type="password" id="admin-pw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸">
        <button onclick="adminLogin()">ì ‘ì†í•˜ê¸°</button>
    </div>
    <div id="dashboard-screen">
        <h3 id="dashboard-title" style="text-align:center; color:#a6adc8; margin-top:0;"></h3>
        <div class="nav-tabs">
            <button class="nav-btn active" onclick="switchTab('chapter')">ğŸ“š ë‹¨ì›ë³„ ë³´ê¸°</button>
            <button class="nav-btn" onclick="switchTab('student')">ğŸ“ í•™ìƒë³„ ë³´ê¸°</button>
        </div>
        <div id="loader" class="loader"></div>
        <div id="loading-msg" style="text-align:center; color:#a6adc8; display:none; margin-bottom:20px;">ë°ì´í„° ë¡œë”© ì¤‘...</div>

        <div class="controls">
            <select id="main-select" onchange="renderView()"><option value="">ì„ íƒí•˜ì„¸ìš”...</option></select>
            
            <div class="filter-group">
                <button class="filter-btn active" id="btn-all" onclick="toggleFilter('all')">ì „ì²´</button>
                <button class="filter-btn active" id="btn-1" onclick="toggleFilter(1)"><span class="dot s-1"></span> ë§ìŒ</button>
                <button class="filter-btn active" id="btn-3" onclick="toggleFilter(3)"><span class="dot s-3"></span> ê³ ì¹¨</button>
                <button class="filter-btn active" id="btn-2" onclick="toggleFilter(2)"><span class="dot s-2"></span> í‹€ë¦¼</button>
                <button class="filter-btn active" id="btn-0" onclick="toggleFilter(0)"><span class="dot s-0"></span> ì•ˆí’ˆ</button>
            </div>

            <button id="btn-save-sheet" class="btn-action btn-orange" onclick="saveReportToSheet()">ğŸ’¾ ë¦¬í¬íŠ¸ ì €ì¥(ì‹œíŠ¸)</button>
            <button id="btn-save-note" class="btn-action btn-red" onclick="saveWrongNotesToSheet()">ğŸ”¢ ì˜¤ë‹µë…¸íŠ¸ ì €ì¥</button>
            <button id="btn-class-analysis" class="btn-action btn-purple" onclick="analyzeClassWeakness()">ğŸ“‹ ìˆ˜ì—… ì¤€ë¹„ ë¶„ì„</button>
            
            <button id="btn-capture" class="btn-action btn-green" style="display:none;" onclick="captureReport()">ğŸ“¸ ìº¡ì²˜</button>
            <button id="btn-total-report" class="btn-action btn-telegram" style="display:none;" onclick="openChartModal()">ğŸš€ ì¢…í•© ë¦¬í¬íŠ¸ ì „ì†¡</button>
        </div>

        <div id="comm-panel">
            <div style="font-size:14px; color:#a6adc8; margin-bottom:10px;">ğŸ“¨ ë©”ì‹œì§€ ì „ì†¡ ì„¼í„° (<span id="comm-student-name"></span>)</div>
            
            <div class="comm-group">
                <span class="comm-label">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ í•™ë¶€ëª¨</span>
                <button class="btn-action btn-green" onclick="sendSMS('parent')">ğŸ“± ë¬¸ì ì „ì†¡ (í°)</button>
                <button class="btn-action btn-dark" onclick="copyText('parent')">ğŸ“„ ë‚´ìš© ë³µì‚¬</button>
                <button class="btn-action btn-dark" onclick="copyNumber('parent')">ğŸ”¢ ë²ˆí˜¸ ë³µì‚¬</button>
            </div>
            
            <div class="comm-group">
                <span class="comm-label">ğŸ“ í•™ìƒ</span>
                <button class="btn-action btn-blue" onclick="sendSMS('student')">ğŸš€ ë…ë ¤ ë¬¸ì (í°)</button>
                <button class="btn-action btn-dark" onclick="copyText('student')">ğŸ’¬ ë©˜íŠ¸ ë³µì‚¬</button>
                <button class="btn-action btn-dark" onclick="copyNumber('student')">ğŸ”¢ ë²ˆí˜¸ ë³µì‚¬</button>
            </div>
        </div>

        <div id="view-area">
             <div id="capture-area">
                <div id="capture-header">
                    <h3 style="margin:0; color:#7d5fff;">ğŸ“Š ì¡°ì°½ì„±T ìˆ˜í•™ ê³¼ì œ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
                    <p style="margin:5px 0; color:#a6adc8;" id="capture-title">ë¶„ì„ ë¦¬í¬íŠ¸</p>
                    <hr style="border:0; border-top:1px solid #45475a; margin:15px 0;">
                </div>
                <div id="report-container" class="report-grid"></div>
            </div>
        </div>
    </div>
</div>

<div id="chartModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeChartModal()">&times;</span>
        <h3 style="margin-top:0;">ğŸ“Š ì¢…í•© ë¶„ì„ ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h3>
        <p style="font-size:14px; color:#ccc; margin-bottom:10px;">ì•„ë˜ ê·¸ë˜í”„ì™€ ë¶„ì„ ë©˜íŠ¸ê°€ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤.</p>
        <div id="chart-container">
            <canvas id="comprehensiveChart"></canvas>
        </div>
        <div style="margin-top:15px; text-align:right;">
            <button class="btn-action btn-telegram" style="width:100%; justify-content:center; padding:15px; font-size:16px;" onclick="sendReportToTelegram()">ğŸš€ í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì¦‰ì‹œ ì „ì†¡</button>
        </div>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec";
    const ADMIN_PW = "0602"; 
    
    let currentClassName = "";
    let globalDB = { sheets: {}, students: [] };
    let currentMode = 'chapter'; 
    let activeFilters = [0, 1, 2, 3]; 
    let reportTextForTelegram = ""; 
    
    // í˜„ì¬ ì„ íƒëœ í•™ìƒì˜ ë°ì´í„° ì €ì¥ìš© (í†µì‹ ìš©)
    let selectedStudentData = { parentPhone: "", studentPhone: "", parentText: "", studentText: "" };

    window.onload = function() {
        fetch(GOOGLE_SCRIPT_URL + "?action=getClassList")
        .then(res => res.json())
        .then(data => {
            const sel = document.getElementById('admin-class-select');
            sel.innerHTML = "";
            data.forEach((cls, idx) => {
                let opt = document.createElement('option');
                opt.value = cls; opt.innerText = cls;
                if(idx===0) opt.selected = true;
                sel.appendChild(opt);
            });
        });
    };

    function adminLogin() {
        const input = document.getElementById('admin-pw').value;
        const cls = document.getElementById('admin-class-select').value;
        if(input === ADMIN_PW) {
            currentClassName = cls;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard-screen').style.display = 'block';
            document.getElementById('dashboard-title').innerText = `[${currentClassName}] ê´€ë¦¬ ëª¨ë“œ`;
            initAdmin();
        } else { alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); }
    }
    
    function initAdmin() {
        document.getElementById('loader').style.display = 'block';
        document.getElementById('loading-msg').style.display = 'block';
        fetch(GOOGLE_SCRIPT_URL + "?action=getAllData&className=" + encodeURIComponent(currentClassName))
        .then(res => res.json()).then(data => {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('loading-msg').style.display = 'none';
            globalDB = data; updateSelectOptions();
        }).catch(err => { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: " + err); location.reload(); });
    }

    function switchTab(tab) {
        currentMode = tab;
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        // ë²„íŠ¼ ê·¸ë£¹ ì œì–´
        const chapterBtns = [document.getElementById('btn-save-sheet'), document.getElementById('btn-save-note'), document.getElementById('btn-class-analysis')];
        const studentBtns = [document.getElementById('btn-capture'), document.getElementById('btn-total-report')];
        
        if(tab === 'chapter') {
            document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
            chapterBtns.forEach(b => b.style.display = 'flex');
            studentBtns.forEach(b => b.style.display = 'none');
        } else {
            document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
            chapterBtns.forEach(b => b.style.display = 'none');
            studentBtns.forEach(b => b.style.display = 'flex');
        }
        document.getElementById('main-select').value = "";
        document.getElementById('report-container').innerHTML = "";
        document.getElementById('comm-panel').style.display = 'none';
        updateSelectOptions();
    }
    
    function updateSelectOptions() {
        const select = document.getElementById('main-select');
        select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”...</option>';
        let list = currentMode === 'chapter' ? Object.keys(globalDB.sheets) : globalDB.students;
        list.forEach(item => {
            let opt = document.createElement('option');
            opt.value = item; opt.innerText = item;
            select.appendChild(opt);
        });
    }

    function toggleFilter(val) {
        if (val === 'all') { activeFilters = [0, 1, 2, 3]; } 
        else {
            if (activeFilters.includes(val)) activeFilters = activeFilters.filter(v => v !== val);
            else activeFilters.push(val);
        }
        updateFilterUI(); renderView();
    }
    function updateFilterUI() {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        activeFilters.forEach(val => { const btn = document.getElementById('btn-' + val); if(btn) btn.classList.add('active'); });
        if ([0, 1, 2, 3].every(v => activeFilters.includes(v))) { document.getElementById('btn-all').classList.add('active'); }
    }
    
    function renderView() {
        const value = document.getElementById('main-select').value;
        const container = document.getElementById('report-container');
        const commPanel = document.getElementById('comm-panel');
        container.innerHTML = "";
        
        if(!value) { commPanel.style.display = 'none'; return; }

        const titleText = currentMode === 'chapter' ? `${value} - ì „ì²´ í•™ìƒ ë¶„ì„` : `${value} í•™ìƒ - ê³¼ì œ ë¶„ì„ ë¦¬í¬íŠ¸`;
        document.getElementById('capture-title').innerText = titleText;

        if (currentMode === 'chapter') {
            commPanel.style.display = 'none';
            const sheetData = globalDB.sheets[value];
            if (!sheetData) return;
            sheetData.forEach(student => { const card = createCard(student['ì´ë¦„'], student); if (card) container.innerHTML += card; });
        } else {
            commPanel.style.display = 'block';
            document.getElementById('comm-student-name').innerText = value;
            prepareCommunicationData(value); 

            const studentName = value;
            const sheetNames = Object.keys(globalDB.sheets);
            sheetNames.forEach(sheetName => {
                const sheetData = globalDB.sheets[sheetName];
                const studentData = sheetData.find(row => row['ì´ë¦„'] === studentName);
                if (studentData) { const card = createCard(sheetName, studentData); if (card) container.innerHTML += card; }
            });
        }
        if(container.innerHTML === "") container.innerHTML = "<p style='text-align:center; width:100%; color:#a6adc8;'>í•´ë‹¹ ì¡°ê±´ì˜ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    }

    // â˜… í†µì‹  ë°ì´í„° ì¤€ë¹„ (ì „í™”ë²ˆí˜¸, ë©˜íŠ¸)
    function prepareCommunicationData(studentName) {
        const sheetNames = Object.keys(globalDB.sheets);
        const lastSheet = sheetNames[sheetNames.length - 1]; // ê°€ì¥ ìµœê·¼ ë‹¨ì› ê¸°ì¤€
        const sheetData = globalDB.sheets[lastSheet];
        const student = sheetData.find(row => row['ì´ë¦„'] === studentName);
        
        if (!student) return;

        selectedStudentData.studentPhone = student['í•™ìƒì „í™”'] || "";
        selectedStudentData.parentPhone = student['í•™ë¶€ëª¨ì „í™”'] || "";
        selectedStudentData.parentText = generateReportText(studentName, lastSheet, student); 
        selectedStudentData.studentText = generateStudentMessage(studentName, lastSheet, student);
    }

    // â˜… í•™ìƒ ë…ë ¤ ë©˜íŠ¸ ìƒì„±
    function generateStudentMessage(name, sheetName, studentData) {
        const keys = Object.keys(studentData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸' && k !== 'ë¦¬í¬íŠ¸' && k !== 'ì˜¤ë‹µë…¸íŠ¸' && k !== 'í•™ìƒì „í™”' && k !== 'í•™ë¶€ëª¨ì „í™”' && k !== 'ë³µìŠµí…ŒìŠ¤íŠ¸');
        keys.sort((a,b)=>parseInt(a)-parseInt(b));
        
        let total = keys.length;
        let doneCount = 0;
        let remainingList = [];
        keys.forEach(k => { if(parseInt(studentData[k])!==0) doneCount++; else remainingList.push(k); });
        
        let percent = total === 0 ? 0 : Math.round((doneCount/total)*100);
        let msg = "";
        let firstName = name.length > 2 ? name.substring(1) : name; 

        if (percent === 100) {
            msg = `${firstName}ì•„! ${sheetName} ìˆ™ì œ 100% ì™„ë£Œë¼ë‹ˆ ëŒ€ë°•ì´ë‹¤! ğŸ‰\nì˜¤ë‹µ ì •ë¦¬ê¹Œì§€ ì™„ë²½í•´. ì˜¤ëŠ˜ í‘¹ ì‰¬ì–´! ğŸ‘`;
        } else if (percent >= 80) {
            msg = `${firstName}ì•„, ìˆ™ì œ ${percent}%ë‚˜ í–ˆë„¤? ê±°ì˜ ë‹¤ í–ˆë‹¤! ğŸ˜\në‚¨ì€ ë¬¸ì œ(${remainingList.slice(0,3).join(',')}ë²ˆ ë“±)ë§Œ ë”± ëë‚´ê³  ì‰¬ì. í™”ì´íŒ…! ğŸ”¥`;
        } else {
            msg = `${firstName}ì•„~ ${sheetName} ìˆ™ì œ ì•„ì§ ${percent}%ì•¼. ğŸ˜¢\nìš°ë¦¬ ì¡°ê¸ˆë§Œ ë” í˜ë‚´ì„œ ì§„ë„ ë§ì¶”ì. í•  ìˆ˜ ìˆì§€? ğŸ’ª`;
        }
        return msg;
    }

    // â˜… ì „ì†¡/ë³µì‚¬ ì•¡ì…˜
    function sendSMS(target) {
        let phone = target === 'parent' ? selectedStudentData.parentPhone : selectedStudentData.studentPhone;
        let text = target === 'parent' ? selectedStudentData.parentText : selectedStudentData.studentText;
        if (!phone) return alert("ì „í™”ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        window.location.href = `sms:${phone}?body=${encodeURIComponent(text)}`;
    }

    function copyText(target) {
        let text = target === 'parent' ? selectedStudentData.parentText : selectedStudentData.studentText;
        navigator.clipboard.writeText(text).then(() => alert("ğŸ“‹ ë‚´ìš©ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
    }

    function copyNumber(target) {
        let phone = target === 'parent' ? selectedStudentData.parentPhone : selectedStudentData.studentPhone;
        if(!phone) return alert("ì „í™”ë²ˆí˜¸ ì—†ìŒ");
        navigator.clipboard.writeText(phone).then(() => alert("ğŸ”¢ ì „í™”ë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
    }

    // â˜… ì¹´ë“œ ìƒì„± (íŠ¹ìˆ˜ ì—´ ì œì™¸)
    function createCard(title, dataObj) {
        const keys = Object.keys(dataObj).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸' && k !== 'ë¦¬í¬íŠ¸' && k !== 'ì˜¤ë‹µë…¸íŠ¸' && k !== 'í•™ìƒì „í™”' && k !== 'í•™ë¶€ëª¨ì „í™”' && k !== 'ë³µìŠµí…ŒìŠ¤íŠ¸');
        let total = keys.length; let correct = 0; let filteredItems = [];
        keys.forEach(k => {
            let val = parseInt(dataObj[k]) || 0;
            if(val === 1 || val === 3) correct++;
            if(activeFilters.includes(val)) { filteredItems.push({ num: k, val: val }); }
        });
        if (filteredItems.length === 0) return null;
        let percent = total === 0 ? 0 : Math.round((correct/total)*100);
        return `<div class="report-card"><div class="card-header"><span>${title}</span><span>${percent}%</span></div><div class="item-list">${filteredItems.map(item => `<span class="item item-${item.val}">${item.num}</span>`).join('')}</div></div>`;
    }

    // â˜… í•™ë¶€ëª¨ ë¦¬í¬íŠ¸ ìƒì„± (ì ìˆ˜ ìë™ ê³„ì‚°)
    function generateReportText(name, sheetName, studentData) {
        const keys = Object.keys(studentData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸' && k !== 'ë¦¬í¬íŠ¸' && k !== 'ì˜¤ë‹µë…¸íŠ¸' && k !== 'í•™ìƒì „í™”' && k !== 'í•™ë¶€ëª¨ì „í™”' && k !== 'ë³µìŠµí…ŒìŠ¤íŠ¸');
        keys.sort((a, b) => parseInt(a) - parseInt(b));

        let rawInput = studentData['ë³µìŠµí…ŒìŠ¤íŠ¸'];
        let testDisplay = "   ì  (  /6)";
        if (rawInput !== undefined && rawInput !== "") {
            let correctCount = parseInt(rawInput);
            if (!isNaN(correctCount)) {
                let wrongCount = 6 - correctCount;
                let score = 100 - (wrongCount * 5);
                if (score < 0) score = 0; 
                testDisplay = `${score}ì  (${correctCount}/6)`;
            }
        }

        let total = keys.length;
        let doneCount = 0;
        let remainingList = [];
        let fixedList = [];

        keys.forEach(k => {
            let val = parseInt(studentData[k]) || 0;
            if (val !== 0) doneCount++; 
            else remainingList.push(k + "ë²ˆ"); 
            if (val === 3) fixedList.push(k + "ë²ˆ");
        });

        let percent = total === 0 ? 0 : Math.round((doneCount / total) * 100);
        let comment = "";
        if (percent === 100) comment = "ì„±ì‹¤í•˜ê²Œ ëª¨ë“  ê³¼ì œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ì˜¤ë‹µ ì •ë¦¬ê¹Œì§€ í›Œë¥­í•©ë‹ˆë‹¤! ê°€ì •ì—ì„œë„ ë§ì€ ì¹­ì°¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.";
        else if (percent >= 90) comment = "ëŒ€ë¶€ë¶„ì˜ ê³¼ì œë¥¼ ì˜ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤. ë‚¨ì€ ëª‡ ë¬¸í•­ë§Œ ë§ˆë¬´ë¦¬í•˜ë©´ ì™„ë²½í•©ë‹ˆë‹¤.";
        else if (percent >= 70) comment = "ê³¼ì œ ìˆ˜í–‰ì´ ì›í™œí•©ë‹ˆë‹¤. ë‹¤ë§Œ, ë‚¨ì€ ë¬¸í•­ë“¤ì€ ì´ë²ˆ ì£¼ë§ì„ ì´ìš©í•´ ë§ˆë¬´ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì§€ë„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.";
        else if (percent >= 50) comment = "ê³¼ì œ ì™„ë£Œìœ¨ì´ ë‹¤ì†Œ ë‚®ìŠµë‹ˆë‹¤. í•™ìŠµ ê³µë°±ì´ ìƒê¸°ì§€ ì•Šë„ë¡ ê°€ì •ì—ì„œë„ ë‚¨ì€ ë¬¸ì œ í’€ì´ë¥¼ ë…ë ¤í•´ ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤.";
        else comment = "í˜„ì¬ ê³¼ì œ ë¯¸í¡ìœ¼ë¡œ í•™ìŠµ ê²°ì†ì´ ìš°ë ¤ë©ë‹ˆë‹¤. í•™ìƒì´ ìˆ˜ì—… ì§„ë„ë¥¼ ì˜ ë”°ë¼ê°ˆ ìˆ˜ ìˆë„ë¡ ê°€ì •ì—ì„œì˜ ê°ë³„í•œ ê´€ì‹¬ê³¼ ì§€ë„ê°€ í•„ìš”í•©ë‹ˆë‹¤.";

        let text = `[ì¡°ì°½ì„±T ìˆ˜í•™ ì•Œë¦¼]\n`;
        text += `${name} í•™ìƒ - ${sheetName}\n`;
        text += `ë³µìŠµí…ŒìŠ¤íŠ¸: ${testDisplay}\n`; 
        text += `ìˆ™ì œ ì™„ë£Œìœ¨: ${percent}% (${doneCount}/${total})\n`;
        
        if (remainingList.length > 0) {
            if(remainingList.length > 15) text += `ë‚¨ì€ ë¬¸ì œ: ${remainingList.slice(0, 15).join(', ')} ì™¸ ${remainingList.length - 15}ë¬¸í•­\n`;
            else text += `ë‚¨ì€ ë¬¸ì œ: ${remainingList.join(', ')}\n`;
        } else { text += `ë‚¨ì€ ë¬¸ì œ: ì—†ìŒ (ì™„ë£Œ)\n`; }

        if (fixedList.length > 0) {
            if(fixedList.length > 15) text += `ì˜¤ë‹µ ì™„ë£Œ: ${fixedList.slice(0, 15).join(', ')} ì™¸ ${fixedList.length - 15}ë¬¸í•­\n`;
            else text += `ì˜¤ë‹µ ì™„ë£Œ: ${fixedList.join(', ')}\n`;
        }
        text += `${comment}`;
        return text;
    }

    // â˜… ì‹œíŠ¸ ì €ì¥
    function saveReportToSheet() {
        const sheetName = document.getElementById('main-select').value;
        if (!sheetName) return alert("ë‹¨ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        if (!confirm(`'${sheetName}' ë¦¬í¬íŠ¸ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const sheetData = globalDB.sheets[sheetName];
        let reports = sheetData.map(student => ({ name: student['ì´ë¦„'], text: generateReportText(student['ì´ë¦„'], sheetName, student) }));
        sendBatchData("saveReportBatch", sheetName, reports);
    }

    // â˜… ì˜¤ë‹µë…¸íŠ¸ ì €ì¥
    function saveWrongNotesToSheet() {
        const sheetName = document.getElementById('main-select').value;
        if (!sheetName) return alert("ë‹¨ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        if (!confirm(`í˜„ì¬ í•„í„°ë§ëœ ë¬¸í•­ ë²ˆí˜¸ë¥¼\n'ì˜¤ë‹µë…¸íŠ¸' ì—´ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const sheetData = globalDB.sheets[sheetName];
        let reports = sheetData.map(student => {
            const keys = Object.keys(student).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸' && k !== 'ë¦¬í¬íŠ¸' && k !== 'ì˜¤ë‹µë…¸íŠ¸' && k !== 'í•™ìƒì „í™”' && k !== 'í•™ë¶€ëª¨ì „í™”' && k !== 'ë³µìŠµí…ŒìŠ¤íŠ¸');
            let notes = keys.filter(k => activeFilters.includes(parseInt(student[k]) || 0));
            notes.sort((a,b) => parseInt(a) - parseInt(b));
            return { name: student['ì´ë¦„'], text: notes.join(", ") };
        });
        sendBatchData("saveWrongNotesBatch", sheetName, reports);
    }

    function sendBatchData(action, sheetName, reports) {
        document.getElementById('loader').style.display = 'block';
        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: action, className: currentClassName, sheetName: sheetName, reports: reports })
        })
        .then(res => res.json())
        .then(json => {
            document.getElementById('loader').style.display = 'none';
            if (json.status === "success") alert("âœ… ì €ì¥ ì™„ë£Œ!"); else alert("ì €ì¥ ì‹¤íŒ¨: " + json.message);
        })
        .catch(err => { document.getElementById('loader').style.display = 'none'; alert("ì„œë²„ ì˜¤ë¥˜: " + err); });
    }

    // â˜… ìˆ˜ì—… ì¤€ë¹„ ë¶„ì„
    function analyzeClassWeakness() {
        const sheetName = document.getElementById('main-select').value;
        if (!sheetName) return alert("ë‹¨ì›ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        const sheetData = globalDB.sheets[sheetName];
        let totalStudents = sheetData.length;
        let qStats = {};
        sheetData.forEach(student => {
            const keys = Object.keys(student).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸' && k !== 'ë¦¬í¬íŠ¸' && k !== 'ì˜¤ë‹µë…¸íŠ¸' && k !== 'í•™ìƒì „í™”' && k !== 'í•™ë¶€ëª¨ì „í™”' && k !== 'ë³µìŠµí…ŒìŠ¤íŠ¸');
            keys.forEach(k => {
                if(!qStats[k]) qStats[k] = { wrong: 0, none: 0, totalBad: 0 };
                let val = parseInt(student[k]) || 0;
                if(val === 2) qStats[k].wrong++;
                if(val === 0) qStats[k].none++;
                if(val === 0 || val === 2) qStats[k].totalBad++;
            });
        });
        let sortedQs = Object.keys(qStats).map(k => ({ num: k, ...qStats[k] }));
        sortedQs.sort((a, b) => b.totalBad - a.totalBad);
        let text = `[${currentClassName} - ${sheetName}] ìˆ˜ì—… ì¤€ë¹„ ë¶„ì„\n*ì´ì›: ${totalStudents}ëª…*\n\n`;
        let urgent = sortedQs.filter(q => (q.totalBad/totalStudents) >= 0.5);
        let warning = sortedQs.filter(q => (q.totalBad/totalStudents) >= 0.3 && (q.totalBad/totalStudents) < 0.5);
        if(urgent.length > 0) { text += `ğŸš¨ ìµœìš°ì„  í•´ì„¤ (ì˜¤ë‹µë¥  50%â†‘)\n`; urgent.forEach(q => { text += `${q.num}ë²ˆ (${q.totalBad}ëª…) - ë¯¸ì™„ë£Œ${q.none}, í‹€ë¦¼${q.wrong}\n`; }); }
        else if (warning.length > 0) { text += `âš ï¸ ì£¼ì˜ ë¬¸í•­ (ì˜¤ë‹µë¥  30%â†‘)\n`; warning.forEach(q => { text += `${q.num}ë²ˆ (${q.totalBad}ëª…)\n`; }); }
        else { text += `ğŸ‘ íŠ¹ë³„íˆ ì·¨ì•½í•œ ê³µí†µ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.\n`; }
        
        text += `\n--------------------------------\nğŸ¯ ë‚˜ë§Œ í‹€ë¦° ë¬¸ì œ (ê°œë³„ ì§€ë„ìš©)\n*ë³¸ì¸ í¬í•¨ 2ëª… ì´í•˜ ì˜¤ë‹µ ë¬¸í•­*\n\n`;
        let hasPersonalData = false;
        sheetData.forEach(student => {
            const keys = Object.keys(student).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸' && k !== 'ë¦¬í¬íŠ¸' && k !== 'ì˜¤ë‹µë…¸íŠ¸' && k !== 'í•™ìƒì „í™”' && k !== 'í•™ë¶€ëª¨ì „í™”' && k !== 'ë³µìŠµí…ŒìŠ¤íŠ¸');
            keys.sort((a,b) => parseInt(a) - parseInt(b));
            let myUniqueErrors = [];
            keys.forEach(k => {
                let val = parseInt(student[k]) || 0;
                if ((val === 0 || val === 2) && qStats[k].totalBad <= 2) { myUniqueErrors.push(`${k}ë²ˆ(${qStats[k].totalBad})`); }
            });
            if (myUniqueErrors.length > 0) { hasPersonalData = true; text += `${student['ì´ë¦„']}: ${myUniqueErrors.join(', ')}\n`; }
        });
        if (!hasPersonalData) text += "(í•´ë‹¹ ì‚¬í•­ ì—†ìŒ)";
        navigator.clipboard.writeText(text).then(() => alert("ğŸ“‹ ìˆ˜ì—… ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
    }

    function captureReport() {
        const captureArea = document.getElementById('capture-area');
        const header = document.getElementById('capture-header');
        if(!document.getElementById('main-select').value) return alert("ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
        header.style.display = 'block';
        html2canvas(captureArea, { backgroundColor: "#1e1e2e", scale: 2 }).then(canvas => {
            header.style.display = 'none';
            const link = document.createElement('a');
            link.download = document.getElementById('main-select').value + '_ë¶„ì„ë¦¬í¬íŠ¸.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    // â˜… ê·¸ë˜í”„ ëª¨ë‹¬ & í…”ë ˆê·¸ë¨
    let chartInstance = null;
    function openChartModal() {
        const name = document.getElementById('main-select').value;
        if(!name) return alert("í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        
        document.getElementById('chartModal').style.display = 'block';
        reportTextForTelegram = generateComprehensiveText(name);

        const sheetNames = Object.keys(globalDB.sheets);
        const labels = [];
        const dataGreen = [];
        const dataBlue = [];
        const dataRed = [];
        const dataGray = [];

        sheetNames.forEach(sName => {
            labels.push(sName.replace(/\[|\]/g, ''));
            const sData = globalDB.sheets[sName];
            const myRow = sData.find(r => r['ì´ë¦„'] === name);
            
            let g=0, b=0, r=0, w=0;
            if(myRow) {
                const keys = Object.keys(myRow).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸' && k !== 'ë¦¬í¬íŠ¸' && k !== 'ì˜¤ë‹µë…¸íŠ¸' && k !== 'í•™ìƒì „í™”' && k !== 'í•™ë¶€ëª¨ì „í™”' && k !== 'ë³µìŠµí…ŒìŠ¤íŠ¸');
                keys.forEach(k => {
                    let v = parseInt(myRow[k]) || 0;
                    if(v===1) g++; else if(v===3) b++; else if(v===2) r++; else w++;
                });
            }
            dataGreen.push(g); dataBlue.push(b); dataRed.push(r); dataGray.push(w);
        });

        const ctx = document.getElementById('comprehensiveChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'ë§ìŒ', data: dataGreen, backgroundColor: '#00A86B' }, 
                    { label: 'ê³ ì¹¨', data: dataBlue, backgroundColor: '#218c74' }, 
                    { label: 'í‹€ë¦¼', data: dataRed, backgroundColor: '#E31A1A' }, 
                    { label: 'ì•ˆí’ˆ', data: dataGray, backgroundColor: '#F2F4F6' } 
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                plugins: {
                    legend: { position: 'bottom' },
                    afterDatasetsDraw: function(chart) {
                        var ctx = chart.ctx;
                        chart.data.datasets.forEach(function(dataset, i) {
                            var meta = chart.getDatasetMeta(i);
                            if (!meta.hidden && i === 3) { 
                                meta.data.forEach(function(element, index) {
                                    var total = dataGreen[index] + dataBlue[index] + dataRed[index] + dataGray[index];
                                    var correct = dataGreen[index] + dataBlue[index];
                                    var percent = total === 0 ? 0 : Math.round((correct / total) * 100);
                                    ctx.fillStyle = '#1e1e2e';
                                    ctx.font = Chart.helpers.fontString(12, 'bold', 'Pretendard');
                                    var dataString = percent + "%";
                                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                                    var position = element.tooltipPosition();
                                    ctx.fillText(dataString, position.x, position.y - 15);
                                });
                            }
                        });
                    }
                }
            }
        });
    }

    function closeChartModal() { document.getElementById('chartModal').style.display = 'none'; }

    function sendReportToTelegram() {
        if(!chartInstance) return;
        const btn = document.querySelector('.btn-telegram');
        const originalText = btn.innerText;
        btn.innerText = "ì „ì†¡ ì¤‘... â³";
        btn.disabled = true;

        const canvas = document.getElementById('comprehensiveChart');
        const imageData = canvas.toDataURL('image/png');

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: new URLSearchParams({
                'action': 'sendReportToTelegram',
                'imageData': imageData,
                'caption': reportTextForTelegram
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") { alert("ğŸš€ í…”ë ˆê·¸ë¨ ì „ì†¡ ì™„ë£Œ!"); closeChartModal(); } 
            else { alert("ì „ì†¡ ì‹¤íŒ¨: " + data.message); }
            btn.innerText = originalText; btn.disabled = false;
        })
        .catch(err => { alert("ì „ì†¡ ì˜¤ë¥˜: " + err); btn.innerText = originalText; btn.disabled = false; });
    }

    function generateComprehensiveText(name) {
        // (ì¢…í•© ë¶„ì„ ë¡œì§ - íŠ¹ìˆ˜ ì—´ ì œì™¸í•˜ê³  ê³„ì‚°)
        const sheetNames = Object.keys(globalDB.sheets);
        let greenList = [], blueList = [], redCandidates = [];
        
        sheetNames.forEach(sName => {
            const sData = globalDB.sheets[sName];
            let totalGreen=0, totalBlue=0, totalItems=0;
            sData.forEach(row => {
                const keys = Object.keys(row).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸' && k !== 'ë¦¬í¬íŠ¸' && k !== 'ì˜¤ë‹µë…¸íŠ¸' && k !== 'í•™ìƒì „í™”' && k !== 'í•™ë¶€ëª¨ì „í™”' && k !== 'ë³µìŠµí…ŒìŠ¤íŠ¸');
                keys.forEach(k => { let v = parseInt(row[k])||0; totalItems++; if(v===1) totalGreen++; if(v===3) totalBlue++; });
            });
            let avgGreenRate = totalItems===0?0:(totalGreen/totalItems)*100;
            let avgBlueRate = totalItems===0?0:(totalBlue/totalItems)*100;
            
            const myRow = sData.find(r => r['ì´ë¦„'] === name);
            if(myRow) {
                const keys = Object.keys(myRow).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex' && k !== 'ì „í™”ë²ˆí˜¸' && k !== 'ë¦¬í¬íŠ¸' && k !== 'ì˜¤ë‹µë…¸íŠ¸' && k !== 'í•™ìƒì „í™”' && k !== 'í•™ë¶€ëª¨ì „í™”' && k !== 'ë³µìŠµí…ŒìŠ¤íŠ¸');
                let myGreen=0, myBlue=0, myTotal=0;
                keys.forEach(k => { let v = parseInt(myRow[k])||0; myTotal++; if(v===1) myGreen++; if(v===3) myBlue++; });
                if(myTotal>0) {
                    let myGreenRate = (myGreen/myTotal)*100;
                    let myBlueRate = (myBlue/myTotal)*100;
                    let myScore = ((myGreen+myBlue)/myTotal)*100;
                    if (myGreenRate >= avgGreenRate) greenList.push({name:sName});
                    if (myBlueRate > 0 && myBlueRate >= avgBlueRate) blueList.push({name:sName});
                    redCandidates.push({name:sName, score:myScore});
                }
            }
        });

        redCandidates.sort((a,b)=>a.score-b.score);
        let redList = [], isPerfect = false;
        if(redCandidates.length>0) {
            if(redCandidates[0].score >= 95) isPerfect = true;
            else { redList.push(redCandidates[0]); if(redCandidates.length>1 && redCandidates[1].score < 80) redList.push(redCandidates[1]); }
        }

        let text = `[ì¡°ì°½ì„±T ìˆ˜í•™ ì¢…í•© ë¶„ì„]\nğŸ“Œ í•™ìƒ: ${name}\nğŸ“… ìˆ˜ì—…: ${currentClassName}\n\n`;
        text += `1ï¸âƒ£ í•µì‹¬ ì—­ëŸ‰ ë¶„ì„\n`;
        if (blueList.length >= greenList.length && blueList.length > 0) text += `ğŸ”¥ 'ì˜¤ë‹µ ìˆ˜ì • ëŠ¥ë ¥' íƒì›” (ê³¼ì œì§‘ì°©ë ¥ ìš°ìˆ˜)\n`;
        else if (greenList.length > 0) text += `ğŸŸ¢ 'ê°œë… ì´í•´ë„' ìš°ìˆ˜ (ì§ê´€ë ¥ ìš°ìˆ˜)\n`;
        else text += `ğŸ’ª ì„±ì‹¤í•œ í•™ìŠµ íƒœë„ (ê¾¸ì¤€í•¨)\n`;

        text += `\n2ï¸âƒ£ ë‹¨ì›ë³„ ìƒì„¸\n`;
        if(greenList.length>0) text += `ğŸŸ¢ ê°œë…ì™„ì„±: ${greenList.map(i=>i.name).join(', ')}\n`;
        if(blueList.length>0) text += `ğŸ”µ ì•½ì ê·¹ë³µ: ${blueList.map(i=>i.name).join(', ')}\n`;
        if(isPerfect) text += `ğŸ’ ì™„ë²½í•¨ (ì•½ì  ì—†ìŒ)\n`;
        else if(redList.length>0) text += `ğŸ”´ ë³´ì™„í•„ìš”: ${redList.map(i=>i.name).join(', ')}\n`;
        
        return text;
    }
</script>
</body>
</html>
