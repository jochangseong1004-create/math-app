<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec"; 
    
    // ë¬´ì‹œí•´ì•¼ í•  ì—´ ëª©ë¡
    const EXCLUDED_KEYS = ['ì´ë¦„', 'ë¹„ë²ˆ', 'rowIndex', 'ì „í™”ë²ˆí˜¸', 'ë¦¬í¬íŠ¸', 'ì˜¤ë‹µë…¸íŠ¸', 'í•™ìƒì „í™”', 'í•™ë¶€ëª¨ì „í™”', 'ë³µìŠµí…ŒìŠ¤íŠ¸'];

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playPopSound() { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    function toggleLoader(show) { document.getElementById('global-loader').style.display = show ? 'flex' : 'none'; }
    window.addEventListener('popstate', function(event) { if (document.getElementById('screen-game').classList.contains('active')) { checkBackNavigation(); } });
    
    window.onload = function() {
        fetch(GOOGLE_SCRIPT_URL + "?action=getClassList")
        .then(res => res.json())
        .then(data => {
            const sel = document.getElementById('login-class-select');
            sel.innerHTML = "";
            data.forEach((cls, idx) => {
                let opt = document.createElement('option');
                opt.value = cls; opt.innerText = cls;
                if(idx===0) opt.selected = true;
                sel.appendChild(opt);
            });
        });
    };

    let userCredentials = { className: "", name: "", pw: "" }; 
    let currentSheetName = ""; 
    let currentUserRowIndex = -1; 
    let tempChanges = {}; 
    let allChapters = []; 
    let myChart = null; 
    let currentClassData = []; // í˜„ì¬ ë³´ê³  ìˆëŠ” ë‹¨ì›ì˜ ì „ì²´ í•™ìƒ ë°ì´í„°
    
    // â˜…â˜…â˜… [í•µì‹¬] ë°ì´í„° ìºì‹œ ì €ì¥ì†Œ (ì—¬ê¸°ì— ë¶ˆëŸ¬ì˜¨ ë‹¨ì› ì •ë³´ë¥¼ ì €ì¥í•¨)
    let sheetCache = {}; 

    const ICONS = ["âšª", "ğŸŸ¢", "ğŸ”´", "âœ…"]; const CLASS_NAMES = ["status-0", "status-1", "status-2", "status-3"];
    const TIER_ICONS = { "CHALLENGER": "ğŸ‘‘", "DIAMOND": "ğŸ’", "PLATINUM": "ğŸ’ ", "GOLD": "ğŸ¥‡", "SILVER": "ğŸ¥ˆ", "BRONZE": "ğŸ¥‰", "IRON": "ğŸ›¡ï¸" };

    function checkBackNavigation() { if (Object.keys(tempChanges).length > 0) { history.pushState({page: 'game'}, document.title, "#game"); document.getElementById('exit-modal').style.display = 'flex'; } else { exitWithoutSave(); } }
    function saveAndExit() { document.getElementById('exit-modal').style.display = 'none'; saveData(true); }
    function exitWithoutSave() { document.getElementById('exit-modal').style.display = 'none'; tempChanges = {}; currentSheetName = ""; showScreen('screen-chapter'); filterChapters(); history.replaceState(null, null, ' '); }

    function goToChapterSelect() { 
        const cls = document.getElementById('login-class-select').value;
        const name = document.getElementById('input-name').value.trim(); 
        const pw = document.getElementById('input-pw').value.trim(); 
        if(!name || !pw) { alert("ì´ë¦„ê³¼ ë¹„ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; } 
        
        userCredentials.className = cls;
        userCredentials.name = name; 
        userCredentials.pw = pw; 
        
        // ë¡œê·¸ì¸ ì‹œì—ëŠ” ìºì‹œ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ìˆ˜ì—…ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
        sheetCache = {};

        toggleLoader(true); 
        fetch(GOOGLE_SCRIPT_URL + "?action=loginAndGetChapters&className=" + encodeURIComponent(cls) + "&name=" + encodeURIComponent(name) + "&pw=" + encodeURIComponent(pw))
        .then(async (res) => { if (!res.ok) throw new Error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨"); return res.json(); })
        .then(data => { 
            toggleLoader(false); 
            if (!data || data.length === 0) { alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; } 
            allChapters = data; 
            document.getElementById('chapter-title').innerText = `[${cls}] í•™ìŠµí•  ë‹¨ì› ì„ íƒ`;
            showScreen('screen-chapter'); 
            setupClassFilter(data); 
            filterChapters(); 
        }).catch(err => { toggleLoader(false); alert("ì˜¤ë¥˜: " + err.message); }); 
    }

    function setupClassFilter(chapters) { const filter = document.getElementById('class-filter'); filter.innerHTML = '<option value="all">ì „ì²´ ìˆ˜ì—… ë³´ê¸°</option>'; const classes = new Set(); chapters.forEach(chap => { const match = chap.name.match(/^\[(.*?)\]/); if (match) classes.add(match[0]); }); classes.forEach(cls => { const option = document.createElement('option'); option.value = cls; option.innerText = cls.replace(/[\[\]]/g, "") + " ìˆ˜ì—…"; filter.appendChild(option); }); }
    function filterChapters() { const selectedClass = document.getElementById('class-filter').value; const list = document.getElementById('chapter-list'); list.innerHTML = ""; allChapters.forEach(chap => { if (selectedClass === "all" || chap.name.startsWith(selectedClass)) { const btn = document.createElement('button'); btn.className = 'chapter-btn'; const safeTier = chap.tier || "IRON"; const safePercent = chap.percent || 0; const tierIcon = TIER_ICONS[safeTier] || "ğŸ›¡ï¸"; btn.innerHTML = `<span class="chap-name">${chap.name.replace(selectedClass === "all" ? "" : selectedClass, "")}</span><span class="chap-stat">${safePercent}% <span class="stat-icon">${tierIcon}</span></span>`; btn.onclick = () => loadGame(chap.name); list.appendChild(btn); } }); }
    
    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ë‹¨ì› ë¡œë”© (ìºì‹œ ìš°ì„  í™•ì¸) â˜…â˜…â˜…
    function loadGame(sheetName) { 
        currentSheetName = sheetName; 
        history.pushState({page: 'game'}, document.title, "#game"); 
        
        // 1. ìºì‹œ(ë©”ëª¨ë¦¬)ì— ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
        if (sheetCache[sheetName]) {
            // console.log("ğŸš€ ìºì‹œëœ ë°ì´í„° ì‚¬ìš©: " + sheetName);
            currentClassData = sheetCache[sheetName]; 
            renderGameUI(sheetName); // í™”ë©´ ê·¸ë¦¬ê¸° (í•¨ìˆ˜ ë¶„ë¦¬í•¨)
            return;
        }

        // 2. ìºì‹œì— ì—†ìœ¼ë©´ ì„œë²„ í˜¸ì¶œ
        toggleLoader(true); 
        const timestamp = new Date().getTime(); 
        const requestUrl = GOOGLE_SCRIPT_URL + "?action=getData&className=" + encodeURIComponent(userCredentials.className) + "&sheetName=" + encodeURIComponent(sheetName) + "&t=" + timestamp; 
        
        fetch(requestUrl).then(res => res.json()).then(data => { 
            toggleLoader(false); 
            
            // ë°ì´í„° ìºì‹œì— ì €ì¥!
            sheetCache[sheetName] = data;
            currentClassData = data; 
            
            renderGameUI(sheetName);
        }).catch(err => { toggleLoader(false); alert("ë¡œë”© ì‹¤íŒ¨: " + err.message); }); 
    }

    // â˜…â˜…â˜… [ì‹ ê·œ] ê²Œì„ í™”ë©´ ê·¸ë¦¬ê¸° ë¡œì§ (loadGameì—ì„œ ë¶„ë¦¬) â˜…â˜…â˜…
    function renderGameUI(sheetName) {
        const user = currentClassData.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw); 
        if (user) { 
            currentUserRowIndex = user['rowIndex']; 
            showScreen('screen-game'); 
            document.getElementById('game-title').innerText = `${sheetName} - ${user['ì´ë¦„']}`; 
            renderGrid(user); updateChart(user); updateTier(user); 
            document.getElementById('student-comment').value = ""; 
        } else { alert("í•™ìƒ ì •ë³´ ì—†ìŒ"); history.back(); } 
    }

    function renderGrid(userData) { 
        const gridBox = document.getElementById('grid-box'); 
        gridBox.innerHTML = ""; 
        tempChanges = {}; 
        const keys = Object.keys(userData).filter(k => !EXCLUDED_KEYS.includes(k)); 
        keys.sort((a,b) => parseInt(a) - parseInt(b));

        keys.forEach(key => { 
            const val = parseInt(userData[key]) || 0; 
            const div = document.createElement('button'); 
            div.className = `grid-item ${CLASS_NAMES[val]}`; 
            div.dataset.val = val; 
            div.innerHTML = `<div class="q-num">${key}</div><div class="q-icon">${ICONS[val]}</div>`; 
            div.onclick = function() { 
                playPopSound(); 
                let current = (tempChanges[key] !== undefined) ? tempChanges[key] : val; 
                let nextVal = (current + 1) % 4; 
                div.className = `grid-item ${CLASS_NAMES[nextVal]}`; 
                div.dataset.val = nextVal; 
                div.querySelector('.q-icon').innerText = ICONS[nextVal]; 
                tempChanges[key] = nextVal; 
                let previewData = {...userData, ...tempChanges}; 
                updateChart(previewData); 
                updateTier(previewData); 
                applyViewFilter(); 
            }; 
            gridBox.appendChild(div); 
        }); 
        applyViewFilter(); 
    }

    function applyViewFilter() { const checkboxes = document.querySelectorAll('.filter-options input'); const checkedValues = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.value)); const items = document.querySelectorAll('.grid-item'); items.forEach(item => { const val = parseInt(item.dataset.val); if (checkedValues.includes(val)) { item.classList.remove('hidden'); } else { item.classList.add('hidden'); } }); }
    
    function getRank(myData, allData) { 
        const keys = Object.keys(myData).filter(k => !EXCLUDED_KEYS.includes(k)); 
        if (keys.length === 0) return "-"; 
        let scores = allData.map(student => { 
            let score = 0; 
            keys.forEach(k => { let val = parseInt(student[k]) || 0; if (val === 1 || val === 3) score++; }); 
            return { name: student['ì´ë¦„'], score: score }; 
        }); 
        let myScore = 0; 
        keys.forEach(k => { let val = parseInt(tempChanges[k] !== undefined ? tempChanges[k] : myData[k]) || 0; if (val === 1 || val === 3) myScore++; }); 
        let myEntryIndex = scores.findIndex(s => s.name === myData['ì´ë¦„']); if(myEntryIndex !== -1) scores[myEntryIndex].score = myScore; scores.sort((a, b) => b.score - a.score); let rank = scores.findIndex(s => s.name === myData['ì´ë¦„']) + 1; return `${rank}ìœ„ / ${scores.length}ëª…`; 
    }
    
    function getTierName(percent) { if (percent === 100) return "CHALLENGER"; if (percent >= 90) return "DIAMOND"; if (percent >= 70) return "PLATINUM"; if (percent >= 50) return "GOLD"; if (percent >= 30) return "SILVER"; if (percent >= 10) return "BRONZE"; return "IRON"; }
    
    function updateTier(userData) { 
        const keys = Object.keys(userData).filter(k => !EXCLUDED_KEYS.includes(k)); 
        let total = keys.length; 
        let done = 0; 
        keys.forEach(k => { let val = parseInt(userData[k]) || 0; if (val === 1 || val === 3) done++; }); 
        let percent = total === 0 ? 0 : (done / total) * 100; 
        let badge = document.getElementById('tier-badge'); 
        let tierName = getTierName(percent); 
        let tierIcon = TIER_ICONS[tierName] || "ğŸ›¡ï¸"; 
        let rankText = getRank(userData, currentClassData); 
        badge.className = `tier-badge tier-${tierName.toLowerCase()}`; 
        badge.innerHTML = `<div class="tier-row"><span class="tier-icon">${tierIcon}</span> <span class="tier-name">${tierName}</span></div><div class="rank-text">í˜„ì¬ ìˆœìœ„ : ${rankText}</div><div class="tier-progress-bg"><div class="tier-progress-fill" style="width:${percent}%"></div></div>`; 
    }
    
    function getPattern() { const patternCanvas = document.createElement('canvas'); const pCtx = patternCanvas.getContext('2d'); patternCanvas.width = 10; patternCanvas.height = 10; pCtx.fillStyle = '#E8F5E9'; pCtx.fillRect(0,0,10,10); pCtx.strokeStyle = '#218c74'; pCtx.lineWidth = 2; pCtx.beginPath(); pCtx.moveTo(0, 10); pCtx.lineTo(10, 0); pCtx.stroke(); return pCtx.createPattern(patternCanvas, 'repeat'); }
    const centerTextPlugin = { id: 'centerText', beforeDraw: function(chart) { if (chart.config.type !== 'doughnut') return; var width = chart.width, height = chart.height, ctx = chart.ctx; ctx.restore(); let data = chart.data.datasets[0].data; let total = data.reduce((a, b) => a + b, 0); let score = data[1] + data[3]; let percent = total === 0 ? 0 : Math.round((score / total) * 100); var fontSize = (height / 114).toFixed(2); ctx.font = "bold " + fontSize + "em Pretendard"; ctx.textBaseline = "middle"; ctx.fillStyle = "#191F28"; var text = percent + "%", textX = Math.round((width - ctx.measureText(text).width) / 2), textY = height / 2; ctx.fillText(text, textX, textY); ctx.save(); } }; Chart.register(centerTextPlugin);
    
    function updateChart(userData) { 
        const ctx = document.getElementById('progressChart').getContext('2d'); 
        let counts = [0, 0, 0, 0]; 
        const keys = Object.keys(userData).filter(k => !EXCLUDED_KEYS.includes(k)); 
        keys.forEach(key => { const val = parseInt(userData[key]) || 0; counts[val]++; }); 
        if (myChart) myChart.destroy(); 
        const bgColors = ['#F2F4F6', '#00A86B', '#E31A1A', getPattern()]; 
        myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['ì•ˆí’ˆ', 'ë§ìŒ', 'í‹€ë¦¼', 'ê³ ì¹¨'], datasets: [{ data: counts, backgroundColor: bgColors, borderWidth: 2, borderColor: 'white', borderRadius: 20, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } } }); 
    }
    
    function analyzePerformance() { 
        if (!currentClassData || currentClassData.length === 0) return; 
        let myData = currentClassData.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw); 
        let myStatus = {...myData, ...tempChanges}; 
        let questionStats = {}; 
        const keys = Object.keys(myData).filter(k => !EXCLUDED_KEYS.includes(k)); 
        let participatedCount = 0; 
        keys.forEach(key => { 
            let correctCount = 0; let totalStudents = 0; 
            currentClassData.forEach(student => { let val = parseInt(student[key]) || 0; if (val === 1) correctCount++; totalStudents++; }); 
            let count1 = currentClassData.filter(s => parseInt(s[key]) === 1).length; 
            questionStats[key] = totalStudents === 0 ? 0 : (count1 / totalStudents) * 100; 
        }); 
        participatedCount = 0; currentClassData.forEach(s => { if(keys.some(k => parseInt(s[k]) > 0)) participatedCount++; }); 
        let participationRate = participatedCount / currentClassData.length; 
        let regretList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 2 || s === 3; }); 
        let regretHtml = ""; 
        if (regretList.length > 0) { let maxRate = Math.max(...regretList.map(q => questionStats[q])); let topRegretQs = regretList.filter(q => questionStats[q] === maxRate); let qText = topRegretQs.join(', '); let rate = Math.round(maxRate); regretHtml = `<div class="analysis-box" style="border-left-color: #E31A1A;"><b>ğŸš¨ ì‹¤ìˆ˜ ì£¼ì˜!</b><br>${qText}ë²ˆ ë¬¸ì œëŠ” ì¹œêµ¬ë“¤ <b>${rate}%</b>ê°€ ë§í˜”ì–´ìš”. ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”!</div>`; } else { regretHtml = `<div class="analysis-box">ğŸ‘ ì‹¤ìˆ˜ ë°©ì–´ ì„±ê³µ!</div>`; } 
        let proudList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 3; }); 
        let proudHtml = ""; 
        if (proudList.length > 0) { let minRate = Math.min(...proudList.map(q => questionStats[q])); let topProudQs = proudList.filter(q => questionStats[q] === minRate); let qText = topProudQs.join(', '); let rate = Math.round(minRate); proudHtml = `<div class="analysis-box" style="border-left-color: #00A86B;"><b>ğŸ† í‚¬ëŸ¬ ì •ë³µ!</b><br>ì •ë‹µë¥  <b>${rate}%</b>ì¸ ${qText}ë²ˆì„ ê³ ì³ëƒˆêµ°ìš”! ëŒ€ë‹¨í•©ë‹ˆë‹¤.</div>`; } 
        let warningHtml = ""; if (participationRate < 0.5) { warningHtml = `<div class="warning-box">âš ï¸ ì•„ì§ ì œì¶œí•œ ì¹œêµ¬ê°€ ì ì–´ì„œ(${participatedCount}ëª…) ë¶„ì„ì´ ë¶€ì •í™•í•  ìˆ˜ ìˆì–´ìš”.</div>`; } 
        document.getElementById('analysis-content').innerHTML = regretHtml + (proudHtml || "") + warningHtml; 
        document.getElementById('analysis-modal').style.display = 'flex'; 
    }
    
    function closeModal(e, id) { if (e.target === document.getElementById(id)) { document.getElementById(id).style.display = 'none'; } }
    
    function updateLocalStats() { 
        let myData = currentClassData.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw); 
        if (!myData) return; 
        const keys = Object.keys(myData).filter(k => !EXCLUDED_KEYS.includes(k)); 
        let total = 0; let done = 0; 
        keys.forEach(k => { let val = parseInt(tempChanges[k] !== undefined ? tempChanges[k] : myData[k]) || 0; total++; if (val === 1 || val === 3) done++; }); 
        let percent = total === 0 ? 0 : Math.round((done / total) * 100); 
        let tier = getTierName(percent); 
        let chapIndex = allChapters.findIndex(c => c.name === currentSheetName); 
        if (chapIndex !== -1) { allChapters[chapIndex].percent = percent; allChapters[chapIndex].tier = tier; } 
        filterChapters(); 
    }

    // â˜…â˜…â˜… [ìˆ˜ì •ë¨] ì €ì¥ í›„ ì„œë²„ ì¬ì ‘ì† ë°©ì§€ (ë¡œì»¬ ìºì‹œ ê°±ì‹ ) â˜…â˜…â˜…
    function saveData(exitMode = false) {
        const statusDiv = document.getElementById('save-status');
        const keysToSave = Object.keys(tempChanges);
        const comment = document.getElementById('student-comment').value;

        if (keysToSave.length === 0 && (!comment || comment.trim() === "")) { 
            statusDiv.innerText = "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"; statusDiv.style.color = "var(--toss-text-gray)"; 
            if(exitMode) exitWithoutSave(); return; 
        }

        toggleLoader(true); statusDiv.innerText = "ì €ì¥ ë° ì œì¶œ ì¤‘...";
        
        let myData = currentClassData.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
        const keys = Object.keys(myData).filter(k => !EXCLUDED_KEYS.includes(k)); 
        
        let stats = { correct: 0, fixed: 0, wrong: 0, none: 0 };
        let total = 0; let done = 0;
        keys.forEach(k => {
            let val = parseInt(tempChanges[k] !== undefined ? tempChanges[k] : myData[k]) || 0;
            if (val === 1) stats.correct++; else if (val === 3) stats.fixed++; else if (val === 2) stats.wrong++; else stats.none++;
            total++; if (val === 1 || val === 3) done++;
        });
        
        let percent = total === 0 ? 0 : Math.round((done / total) * 100);
        let tierName = getTierName(percent);
        let tierIcon = TIER_ICONS[tierName] || "ğŸ›¡ï¸";
        let tierStr = `${tierIcon} ${tierName} (${percent}%)`;

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: "saveBatch",
                className: userCredentials.className, 
                sheetName: currentSheetName,
                rowIndex: currentUserRowIndex,
                changes: tempChanges,
                studentName: userCredentials.name,
                tierInfo: tierStr,
                stats: stats,
                studentComment: comment 
            })
        })
        .then(res => res.json())
        .then(json => {
            if (json.status !== "success") { toggleLoader(false); throw new Error(json.message || "ì €ì¥ ì‹¤íŒ¨"); }
            
            // 1. ì„±ê³µí–ˆìœ¼ë©´, tempChangesì˜ ë‚´ìš©ì„ ìºì‹œ(sheetCache)ì™€ í˜„ì¬ ë°ì´í„°(currentClassData)ì— ë°˜ì˜
            // (ì„œë²„ì—ì„œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ì§€ ì•Šì•„ë„ ë¨!)
            if (currentClassData) {
                let userIndex = currentClassData.findIndex(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
                if (userIndex !== -1) {
                    // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                    currentClassData[userIndex] = { ...currentClassData[userIndex], ...tempChanges };
                    // ìºì‹œ ì—…ë°ì´íŠ¸
                    if (sheetCache[currentSheetName]) {
                        sheetCache[currentSheetName] = currentClassData;
                    }
                }
            }

            updateLocalStats(); 
            statusDiv.innerText = "âœ… ì œì¶œ ì™„ë£Œ!"; statusDiv.style.color = "#00A86B";
            tempChanges = {}; 
            setTimeout(() => { statusDiv.innerText = ""; }, 3000);
            
            if (exitMode) { 
                toggleLoader(false); 
                exitWithoutSave(); 
            } else { 
                toggleLoader(false); 
                // â˜… ì„œë²„ ì¬í˜¸ì¶œ(loadGame) ëŒ€ì‹  ë¡œì»¬ UIë§Œ ê°±ì‹ 
                renderGameUI(currentSheetName); 
            }
        })
        .catch(err => { toggleLoader(false); console.error(err); statusDiv.innerText = "âŒ ì €ì¥ ì‹¤íŒ¨"; statusDiv.style.color = "#E31A1A"; alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n(ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”)"); });
    }

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function logout() { userCredentials = {}; location.reload(); }
</script>
