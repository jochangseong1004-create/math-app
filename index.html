<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìˆ˜í•™ ì§„ë„í‘œ</title>
    <style>
        /* 1. ìŠ¤íƒ€ì¼ ì„¤ì • (ëª¨ë°”ì¼ ìµœì í™”) */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f5f7; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen { display: flex; flex-direction: column; gap: 10px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button.primary { padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        button.primary:active { background-color: #0056b3; }

        /* ê·¸ë¦¬ë“œ (ì§€ë¢°ì°¾ê¸° ìŠ¤íƒ€ì¼) */
        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); /* í•œ ì¤„ì— 5ê°œ */
            gap: 8px; 
            margin-bottom: 20px; 
        }
        .grid-item {
            aspect-ratio: 1; /* ì •ì‚¬ê°í˜• ìœ ì§€ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none; /* ë“œë˜ê·¸ ë°©ì§€ */
            -webkit-tap-highlight-color: transparent;
        }
        .grid-item:active { transform: scale(0.95); }
        
        /* ìƒíƒœë³„ ìƒ‰ìƒ (ì¦‰ê° ë°˜ì‘) */
        .status-0 { background-color: white; border-color: #ddd; } /* ì•ˆí’ˆ */
        .status-1 { background-color: #d4edda; border-color: #c3e6cb; color: #155724; } /* ë§ìŒ (ì´ˆë¡) */
        .status-2 { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; } /* í‹€ë¦¼ (ë¹¨ê°„) */
        .status-3 { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; } /* ê³ ì¹¨ (íŒŒë‘/ì²´í¬) */

        .q-num { font-size: 12px; color: #666; margin-bottom: 2px; }
        .q-icon { font-size: 24px; line-height: 1; }

        /* ì €ì¥ ë²„íŠ¼ ì˜ì—­ */
        .save-area { text-align: center; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        #save-status { margin-top: 10px; font-size: 14px; color: green; height: 20px; }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“š ìˆ˜í•™ ì§„ë„í‘œ</h2>
    
    <div id="loader" class="loader"></div>

    <div id="login-screen">
        <input type="text" id="input-name" placeholder="ì´ë¦„ (ì˜ˆ: ì¡°ì°½ì„±)">
        <input type="password" id="input-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì˜ˆ: 3629)">
        <button class="primary" onclick="login()">ë¡œê·¸ì¸</button>
        <p style="color:red; font-size:12px; text-align:center; display:none;" id="login-error">ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
    </div>

    <div id="game-screen" style="display:none;">
        <h3 id="welcome-msg" style="text-align:center; margin-bottom:20px;"></h3>
        <p style="text-align:center; font-size:12px; color:gray;">í„°ì¹˜í•˜ë©´ ë°”ë€ë‹ˆë‹¤: âšª â ğŸŸ¢ â ğŸ”´ â âœ…</p>
        
        <div class="grid-container" id="grid-box">
            </div>

        <div class="save-area">
            <button class="primary" style="width:100%; background-color: #28a745;" onclick="saveData()">ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥í•˜ê¸°</button>
            <div id="save-status"></div>
        </div>
    </div>
</div>

<script>
    // â˜…â˜…â˜… ì—¬ê¸°ì— ì•„ê¹Œ ë³µì‚¬í•œ ì›¹ ì•± URLì„ ë„£ìœ¼ì„¸ìš”! â˜…â˜…â˜…
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec";
    // (ìœ„ ì£¼ì†ŒëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤. ë³¸ì¸ ì£¼ì†Œë¡œ ê¼­ ë°”ê¾¸ì„¸ìš”!)

    let allData = [];
    let currentUser = null;
    let tempChanges = {}; // ë³€ê²½ëœ ì‚¬í•­ë§Œ ì„ì‹œ ì €ì¥

    // 0:ì•ˆí’ˆ, 1:ë§ìŒ, 2:í‹€ë¦¼, 3:ê³ ì¹¨
    const ICONS = ["âšª", "ğŸŸ¢", "ğŸ”´", "âœ…"]; 
    const CLASS_NAMES = ["status-0", "status-1", "status-2", "status-3"];

    // 1. ì‹œì‘í•˜ìë§ˆì ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    window.onload = function() {
        document.getElementById('loader').style.display = 'block';
        document.getElementById('login-screen').style.display = 'none';

        fetch(GOOGLE_SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            allData = data;
            document.getElementById('loader').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        })
        .catch(err => {
            alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨! ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
            console.error(err);
        });
    };

    // 2. ë¡œê·¸ì¸ ì²˜ë¦¬
    function login() {
        const name = document.getElementById('input-name').value.trim();
        const pw = document.getElementById('input-pw').value.trim();

        // ì´ë¦„ê³¼ ë¹„ë²ˆìœ¼ë¡œ ìœ ì € ì°¾ê¸°
        const user = allData.find(row => String(row['ì´ë¦„']) === name && String(row['ë¹„ë²ˆ']) === pw);

        if (user) {
            currentUser = user;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('welcome-msg').innerText = `ğŸ‘‹ ì•ˆë…•, ${user['ì´ë¦„']}!`;
            renderGrid();
        } else {
            document.getElementById('login-error').style.display = 'block';
        }
    }

    // 3. ì§€ë¢°ì°¾ê¸° ê·¸ë¦¬ë“œ ê·¸ë¦¬ê¸°
    function renderGrid() {
        const gridBox = document.getElementById('grid-box');
        gridBox.innerHTML = ""; // ì´ˆê¸°í™”

        // ë¬¸ì œ ì»¬ëŸ¼ë§Œ ì¶”ì¶œ (ì´ë¦„, ë¹„ë²ˆ, rowIndex ì œì™¸)
        const keys = Object.keys(currentUser).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        
        keys.forEach(key => {
            const val = parseInt(currentUser[key]) || 0; // í˜„ì¬ ê°’ (ì—†ìœ¼ë©´ 0)

            // ë²„íŠ¼(íƒ€ì¼) ë§Œë“¤ê¸°
            const div = document.createElement('div');
            div.className = `grid-item ${CLASS_NAMES[val]}`;
            div.id = `btn-${key}`;
            
            // ë‚´ìš©ë¬¼
            div.innerHTML = `
                <div class="q-num">${key}</div>
                <div class="q-icon">${ICONS[val]}</div>
            `;

            // â˜… í´ë¦­ ì´ë²¤íŠ¸ (ì¦‰ê° ë°˜ì‘ì˜ í•µì‹¬!)
            div.onclick = function() {
                // ë‹¤ìŒ ìƒíƒœ ê³„ì‚° (0->1->2->3->0)
                let nextVal = (val + 1) % 4;
                
                // 1. í™”ë©´ ì¦‰ì‹œ ë³€ê²½ (CSS í´ë˜ìŠ¤ êµì²´)
                // (ê¸°ì¡´ ìƒíƒœ ì œê±°í•˜ê³  ìƒˆ ìƒíƒœ ì¶”ê°€)
                div.className = `grid-item ${CLASS_NAMES[nextVal]}`;
                div.querySelector('.q-icon').innerText = ICONS[nextVal];

                // 2. ë©”ëª¨ë¦¬ì— ì„ì‹œ ì €ì¥
                currentUser[key] = nextVal; // í˜„ì¬ ë°ì´í„° ê°±ì‹ 
                tempChanges[key] = nextVal; // ë³€ê²½ ëª©ë¡ì— ì¶”ê°€

                // 3. onclick í•¨ìˆ˜ë„ ê°±ì‹  (ë‹¤ìŒ í´ë¦­ì„ ìœ„í•´)
                div.onclick = function() { 
                    updateCell(div, key, nextVal); 
                };
            };
            
            // ì²˜ìŒ í•œ ë²ˆë§Œ ë°”ì¸ë”© í•˜ê¸° ìœ„í•´ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬ ì•ˆ í•˜ê³  ì¼ë‹¨ ì—¬ê¸°ì— ë‘  (ì•½ì‹)
            // ì‹¤ì œ ë¡œì§ì€ ì•„ë˜ updateCell í•¨ìˆ˜ ì‚¬ìš©
            div.onclick = () => updateCell(div, key);

            gridBox.appendChild(div);
        });
    }

    // í´ë¦­ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateCell(element, colName) {
        let currentVal = parseInt(currentUser[colName]) || 0;
        let nextVal = (currentVal + 1) % 4;

        // UI ì¦‰ì‹œ ë°˜ì˜ (ë”œë ˆì´ 0ì´ˆ)
        element.className = `grid-item ${CLASS_NAMES[nextVal]}`;
        element.querySelector('.q-icon').innerText = ICONS[nextVal];

        // ë°ì´í„° ë°˜ì˜
        currentUser[colName] = nextVal;
        tempChanges[colName] = nextVal;
    }

    // 4. ì €ì¥í•˜ê¸° (ì„œë²„ í†µì‹ )
    function saveData() {
        const statusDiv = document.getElementById('save-status');
        const keysToSave = Object.keys(tempChanges);

        if (keysToSave.length === 0) {
            statusDiv.innerText = "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.";
            return;
        }

        statusDiv.innerText = "ì €ì¥ ì¤‘...";
        statusDiv.style.color = "orange";

        // ë³€ê²½ëœ ê²ƒë“¤ì„ í•˜ë‚˜ì”©(í˜¹ì€ í•œêº¼ë²ˆì—) ì„œë²„ë¡œ ë³´ëƒ„
        // ê°„ë‹¨í•˜ê²Œ í•˜ê¸° ìœ„í•´ ìˆœì°¨ì ìœ¼ë¡œ ë³´ëƒ„ (ë¹„ë™ê¸° ë³‘ë ¬ ì²˜ë¦¬ ê°€ëŠ¥í•˜ì§€ë§Œ ì•ˆì •ì„± ìœ„í•´)
        
        let promises = keysToSave.map(colName => {
            return fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // CORS ë¬¸ì œ íšŒí”¼
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    rowIndex: currentUser['rowIndex'],
                    colName: colName,
                    value: tempChanges[colName]
                })
            });
        });

        Promise.all(promises)
        .then(() => {
            statusDiv.innerText = "âœ… ëª¨ë“  ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!";
            statusDiv.style.color = "green";
            tempChanges = {}; // ì„ì‹œ ì €ì¥ì†Œ ë¹„ìš°ê¸°
            setTimeout(() => { statusDiv.innerText = ""; }, 3000);
        })
        .catch(err => {
            statusDiv.innerText = "âŒ ì €ì¥ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            statusDiv.style.color = "red";
        });
    }
</script>

</body>
</html>
