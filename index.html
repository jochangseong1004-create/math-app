<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìˆ˜í•™ ì§„ë„í‘œ</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --toss-blue: #0064FF;
            --toss-bg: #F2F4F6;
            --toss-text-dark: #191F28;
            --toss-text-gray: #8B95A1;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            --radius-L: 24px;
            --radius-M: 16px;
        }

        body {
            font-family: "Pretendard Variable", Pretendard, -apple-system, sans-serif;
            background-color: var(--toss-bg);
            margin: 0;
            padding: 20px;
            color: var(--toss-text-dark);
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px 24px;
            border-radius: var(--radius-L);
            box-shadow: var(--card-shadow);
            min-height: 85vh;
            position: relative;
        }

        h2, h3 { text-align: center; color: var(--toss-text-dark); margin-bottom: 20px; font-weight: 700; }
        
        button { font-family: inherit; transition: all 0.1s ease; cursor: pointer; }
        button:active { transform: scale(0.96); }

        button.primary, button.analyze {
            width: 100%; padding: 16px; border: none; border-radius: var(--radius-M);
            font-size: 17px; font-weight: 600; margin-top: 12px;
        }
        button.primary { background-color: var(--toss-blue); color: white; }
        button.analyze { background-color: #E8F3FF; color: var(--toss-blue); }

        input, select {
            width: 100%; padding: 16px; margin-bottom: 12px; border: none;
            background-color: #F9FAFB; border-radius: var(--radius-M);
            font-size: 17px; font-family: inherit;
            box-sizing: border-box; 
        }
        input:focus, select:focus { outline: 2px solid var(--toss-blue); background: white; }

        .screen { display: none; flex-direction: column; }
        .active { display: flex; }

        /* ì±•í„° ë²„íŠ¼ (ëŒ€ì‹œë³´ë“œ) ìŠ¤íƒ€ì¼ */
        .chapter-btn {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 18px 20px; 
            background: white; border: 1px solid #F2F4F6; border-radius: 16px;
            margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            text-align: left;
        }
        .chapter-btn:hover { background-color: #F9FAFB; }
        .chap-name { font-size: 17px; font-weight: 600; color: #191F28; }
        .chap-stat { font-size: 15px; font-weight: 600; color: #6B7684; display: flex; align-items: center; gap: 8px; }
        .stat-icon { font-size: 20px; }

        /* ë¯¸ë‹ˆë©€ í‹°ì–´ ë°°ì§€ */
        .tier-badge {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-bottom: 24px; padding: 24px 20px; 
            border-radius: 20px; background: white; 
            border: 2px solid #ddd; box-shadow: 0 10px 30px rgba(0,0,0,0.05); transition: 0.3s;
        }
        .tier-row { display: flex; align-items: center; justify-content: center; margin-bottom: 10px; }
        .tier-icon { font-size: 40px; margin-right: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .tier-name { font-size: 26px; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; }
        .rank-text { font-size: 14px; font-weight: 600; color: var(--toss-text-gray); background: #F2F4F6; padding: 6px 14px; border-radius: 20px; margin-bottom: 15px; }
        .tier-progress-bg { width: 100%; height: 8px; background: #F2F4F6; border-radius: 4px; overflow: hidden; }
        .tier-progress-fill { height: 100%; background: #ddd; width: 0%; border-radius: 4px; transition: width 0.5s ease; }

        /* í‹°ì–´ë³„ ìƒ‰ìƒ */
        .tier-iron { border-color: #585858; color: #585858; } .tier-iron .tier-progress-fill { background: #585858; }
        .tier-bronze { border-color: #cd7f32; color: #cd7f32; } .tier-bronze .tier-progress-fill { background: #cd7f32; }
        .tier-silver { border-color: #7f8c8d; color: #7f8c8d; } .tier-silver .tier-progress-fill { background: #7f8c8d; }
        .tier-gold { border-color: #FFB300; color: #FFB300; } .tier-gold .tier-progress-fill { background: #FFB300; }
        .tier-platinum { border-color: #00b894; color: #00b894; } .tier-platinum .tier-progress-fill { background: #00b894; }
        .tier-diamond { border-color: #00CEC9; color: #00CEC9; } .tier-diamond .tier-progress-fill { background: #00CEC9; }
        .tier-challenger { border: 3px solid transparent; background-image: linear-gradient(white, white), linear-gradient(to right, #fbc2eb, #a6c1ee); background-origin: border-box; background-clip: content-box, border-box; }
        .tier-challenger .tier-name { background: linear-gradient(to right, #fbc2eb, #a6c1ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tier-challenger .tier-progress-fill { background: linear-gradient(to right, #fbc2eb, #a6c1ee); }

        .filter-options { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-label { font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #F9FAFB; border-radius: 20px; color: var(--toss-text-gray); transition: 0.2s; font-weight: 500; }
        .filter-label:has(input:checked) { background-color: #E8F3FF; color: var(--toss-blue); font-weight: 700; }

        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 24px; }
        .grid-item { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: white; border-radius: var(--radius-M); border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.2s; }
        .grid-item.hidden { display: none; }
        
        .status-0 { background-color: white; color: var(--toss-text-gray); }
        .status-1 { background-color: #E3FCEF; color: #00A86B; box-shadow: inset 0 0 0 2px #00A86B; }
        .status-2 { background-color: #FFEBEB; color: #E31A1A; box-shadow: inset 0 0 0 2px #E31A1A; }
        .status-3 { background-color: #f0fff4; color: #218c74; box-shadow: inset 0 0 0 2px #218c74; background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(33, 140, 116, 0.1) 5px, rgba(33, 140, 116, 0.1) 10px); }

        .q-num { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .q-icon { font-size: 24px; }
        
        .loader-wrapper { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; border-radius: var(--radius-L); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--toss-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .chart-container { width: 65%; margin: 0 auto 20px auto; position: relative; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 28px; border-radius: var(--radius-L); width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .analysis-box { background: #F9FAFB; padding: 16px; border-radius: var(--radius-M); margin-bottom: 12px; border-left: 5px solid var(--toss-blue); text-align: left; }
        .warning-box { background: #F2F4F6; padding: 14px; border-radius: var(--radius-M); margin-top: 15px; color: var(--toss-text-gray); font-size: 13px; text-align: center; }

        .modal-btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 20px; }
        .btn-yes { background-color: var(--toss-blue); color: white; padding: 14px; border: none; border-radius: 12px; font-weight: 600; }
        .btn-no { background-color: #FFEBEB; color: #E31A1A; padding: 14px; border: none; border-radius: 12px; font-weight: 600; }
        .btn-cancel { background-color: white; color: var(--toss-text-gray); padding: 14px; border: 1px solid #ddd; border-radius: 12px; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <div id="global-loader" class="loader-wrapper"><div class="loader"></div></div>

    <h2>ğŸ“š ìˆ˜í•™ ì§„ë„í‘œ</h2>

    <div id="screen-login" class="screen active">
        <p style="text-align:center; color:var(--toss-text-gray);">ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        <input type="text" id="input-name" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">
        <input type="password" id="input-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì „í™”ë²ˆí˜¸ ë’¤ 4ìë¦¬)">
        <button class="primary" onclick="goToChapterSelect()">ë‚´ ì§„ë„í‘œ ë³´ê¸°</button>
    </div>

    <div id="screen-chapter" class="screen">
        <h3>í•™ìŠµí•  ë‹¨ì›ì„ ì„ íƒí•˜ì„¸ìš”</h3>
        <div style="margin-bottom:15px;">
            <select id="class-filter" onchange="filterChapters()">
                <option value="all">ì „ì²´ ìˆ˜ì—… ë³´ê¸°</option>
            </select>
        </div>
        <div id="chapter-list" style="display:flex; flex-direction:column; gap:10px;"></div>
        <button onclick="logout()" style="background-color:#F2F4F6; color:var(--toss-text-gray); margin-top:20px; width:100%; padding:16px; border:none; border-radius:16px;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="screen-game" class="screen">
        <h3 id="game-title" style="text-align:center; margin:0 0 20px 0;"></h3>
        
        <div id="tier-badge" class="tier-badge tier-iron">
            <div class="tier-row"><span class="tier-icon">ğŸ›¡ï¸</span> <span class="tier-name">IRON</span></div>
            <div class="rank-text" id="rank-display">ìˆœìœ„ ê³„ì‚°ì¤‘...</div>
            <div class="tier-progress-bg"><div id="tier-progress-fill" class="tier-progress-fill"></div></div>
        </div>

        <div class="chart-container"><canvas id="progressChart"></canvas></div>

        <div class="filter-options">
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="0" hidden>âšª ì•ˆí’ˆ</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="1" hidden>ğŸŸ¢ ë§ìŒ</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="2" hidden>ğŸ”´ í‹€ë¦¼</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="3" hidden>âœ… ê³ ì¹¨</label>
        </div>
        
        <div class="grid-container" id="grid-box"></div>

        <div style="text-align:center; margin-top:20px;">
            <div id="save-status" style="height:20px; font-size:14px; font-weight:600; margin-bottom:8px;"></div>
            <div style="display:flex; gap:10px;">
                <button class="analyze" onclick="analyzePerformance()" style="flex:1;">ğŸ¤– AI ë¶„ì„</button>
                <button class="primary" onclick="saveData()" style="flex:2;">ì €ì¥ ë° ì œì¶œ</button>
            </div>
            <button onclick="checkBackNavigation()" style="background-color:transparent; color:var(--toss-text-gray); padding:12px; margin-top:10px; width:100%; border:none;">â† ëª©ë¡ìœ¼ë¡œ</button>
        </div>
    </div>
</div>

<div id="analysis-modal" class="modal-overlay" onclick="closeModal(event, 'analysis-modal')">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ“Š í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
        <div id="analysis-content"></div>
        <button onclick="document.getElementById('analysis-modal').style.display='none'" style="width:100%; padding:16px; background:#F2F4F6; border:none; border-radius:16px; margin-top:20px; font-weight:600;">ë‹«ê¸°</button>
    </div>
</div>

<div id="exit-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-bottom:10px;">ì ê¹ë§Œìš”! ğŸ›‘</h3>
        <p style="color:var(--toss-text-gray); margin-bottom:20px;">ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.<br>ì €ì¥í•˜ê³  ëª©ë¡ìœ¼ë¡œ ë‚˜ê°ˆê¹Œìš”?</p>
        <div class="modal-btn-group">
            <button class="btn-yes" onclick="saveAndExit()">ë„¤, ì €ì¥í•˜ê³  ë‚˜ê°ˆë˜ìš”</button>
            <button class="btn-no" onclick="exitWithoutSave()">ì•„ë‹ˆìš”, ê·¸ëƒ¥ ë‚˜ê°ˆë˜ìš”</button>
            <button class="btn-cancel" onclick="document.getElementById('exit-modal').style.display='none'">ì·¨ì†Œ (ê³„ì† í’€ê¸°)</button>
        </div>
    </div>
</div>

<script>
    // â˜…â˜…â˜… ì„ ìƒë‹˜ URLë¡œ êµì²´ í•„ìˆ˜ â˜…â˜…â˜…
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec"; 
    
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playPopSound() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    function toggleLoader(show) { document.getElementById('global-loader').style.display = show ? 'flex' : 'none'; }

    window.addEventListener('popstate', function(event) {
        if (document.getElementById('screen-game').classList.contains('active')) { checkBackNavigation(); }
    });

    function checkBackNavigation() {
        if (Object.keys(tempChanges).length > 0) {
            history.pushState({page: 'game'}, document.title, "#game"); 
            document.getElementById('exit-modal').style.display = 'flex';
        } else { exitWithoutSave(); }
    }

    function saveAndExit() { document.getElementById('exit-modal').style.display = 'none'; saveData(true); }
    
    // â˜… [ìˆ˜ì •ë¨] ëª©ë¡ìœ¼ë¡œ ë‚˜ê°ˆ ë•Œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤!
    function exitWithoutSave() {
        document.getElementById('exit-modal').style.display = 'none';
        tempChanges = {}; 
        currentSheetName = "";
        
        // ëª©ë¡ í™”ë©´ ê°€ê¸° ì „ ìµœì‹  ë°ì´í„° ë¡œë“œ
        toggleLoader(true);
        fetch(GOOGLE_SCRIPT_URL + "?action=loginAndGetChapters&name=" + encodeURIComponent(userCredentials.name) + "&pw=" + encodeURIComponent(userCredentials.pw))
        .then(res => res.json())
        .then(data => {
            toggleLoader(false);
            if (data && data.length > 0) {
                allChapters = data;
                filterChapters(); // ìµœì‹  ì ìˆ˜ë¡œ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            }
            showScreen('screen-chapter');
            history.replaceState(null, null, ' ');
        })
        .catch(err => {
            toggleLoader(false);
            showScreen('screen-chapter'); // ì—ëŸ¬ë‚˜ë„ ì¼ë‹¨ ì´ë™
            history.replaceState(null, null, ' ');
        });
    }

    let userCredentials = { name: "", pw: "" };
    let currentSheetName = "";
    let currentUserRowIndex = -1;
    let tempChanges = {}; 
    let allChapters = []; 
    let myChart = null;
    let currentClassData = [];

    const ICONS = ["âšª", "ğŸŸ¢", "ğŸ”´", "âœ…"]; 
    const CLASS_NAMES = ["status-0", "status-1", "status-2", "status-3"];
    const TIER_ICONS = { "CHALLENGER": "ğŸ‘‘", "DIAMOND": "ğŸ’", "PLATINUM": "ğŸ’ ", "GOLD": "ğŸ¥‡", "SILVER": "ğŸ¥ˆ", "BRONZE": "ğŸ¥‰", "IRON": "ğŸ›¡ï¸" };

    function goToChapterSelect() {
        const name = document.getElementById('input-name').value.trim();
        const pw = document.getElementById('input-pw').value.trim();
        if(!name || !pw) { alert("ì´ë¦„ê³¼ ë¹„ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        userCredentials.name = name;
        userCredentials.pw = pw;
        toggleLoader(true);

        fetch(GOOGLE_SCRIPT_URL + "?action=loginAndGetChapters&name=" + encodeURIComponent(name) + "&pw=" + encodeURIComponent(pw))
        .then(res => res.json())
        .then(data => {
            toggleLoader(false);
            if (!data || data.length === 0) { alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }
            allChapters = data; 
            showScreen('screen-chapter');
            setupClassFilter(data);
            filterChapters(); 
        })
        .catch(err => {
            toggleLoader(false);
            alert("ëª©ë¡ ë¡œë”© ì‹¤íŒ¨.");
        });
    }

    function setupClassFilter(chapters) {
        const filter = document.getElementById('class-filter');
        filter.innerHTML = '<option value="all">ì „ì²´ ìˆ˜ì—… ë³´ê¸°</option>';
        const classes = new Set();
        chapters.forEach(chap => {
            const match = chap.name.match(/^\[(.*?)\]/);
            if (match) classes.add(match[0]); 
        });
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls;
            option.innerText = cls.replace(/[\[\]]/g, "") + " ìˆ˜ì—…"; 
            filter.appendChild(option);
        });
    }

    function filterChapters() {
        const selectedClass = document.getElementById('class-filter').value;
        const list = document.getElementById('chapter-list');
        list.innerHTML = "";
        
        allChapters.forEach(chap => {
            if (selectedClass === "all" || chap.name.startsWith(selectedClass)) {
                const btn = document.createElement('button');
                btn.className = 'chapter-btn';
                
                // [NEW] ëŒ€ì‹œë³´ë“œ ì•„ì´í…œ (92%, ì•„ì´ì½˜)
                const tierIcon = TIER_ICONS[chap.tier] || "ğŸ›¡ï¸";
                btn.innerHTML = `
                    <span class="chap-name">${chap.name.replace(selectedClass === "all" ? "" : selectedClass, "")}</span>
                    <span class="chap-stat">${chap.percent}% <span class="stat-icon">${tierIcon}</span></span>
                `;
                
                btn.onclick = () => loadGame(chap.name);
                list.appendChild(btn);
            }
        });
    }

    function loadGame(sheetName) {
        currentSheetName = sheetName;
        history.pushState({page: 'game'}, document.title, "#game");
        toggleLoader(true);
        const timestamp = new Date().getTime(); 
        const requestUrl = GOOGLE_SCRIPT_URL + "?action=getData&sheetName=" + encodeURIComponent(sheetName) + "&t=" + timestamp;

        fetch(requestUrl)
        .then(res => res.json())
        .then(data => {
            toggleLoader(false);
            currentClassData = data;
            const user = data.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
            if (user) {
                currentUserRowIndex = user['rowIndex'];
                showScreen('screen-game');
                document.getElementById('game-title').innerText = `${sheetName} - ${user['ì´ë¦„']}`;
                renderGrid(user);
                updateChart(user);
                updateTier(user);
            } else {
                alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                history.back(); 
            }
        })
        .catch(err => {
            toggleLoader(false);
            alert("ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
        });
    }

    function renderGrid(userData) {
        const gridBox = document.getElementById('grid-box');
        gridBox.innerHTML = "";
        tempChanges = {}; 
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            const div = document.createElement('button');
            div.className = `grid-item ${CLASS_NAMES[val]}`;
            div.dataset.val = val;
            div.innerHTML = `<div class="q-num">${key}</div><div class="q-icon">${ICONS[val]}</div>`;
            div.onclick = function() {
                playPopSound(); 
                let current = (tempChanges[key] !== undefined) ? tempChanges[key] : val;
                let nextVal = (current + 1) % 4;
                div.className = `grid-item ${CLASS_NAMES[nextVal]}`;
                div.dataset.val = nextVal;
                div.querySelector('.q-icon').innerText = ICONS[nextVal];
                tempChanges[key] = nextVal;
                let previewData = {...userData, ...tempChanges};
                updateChart(previewData);
                updateTier(previewData);
                applyViewFilter();
            };
            gridBox.appendChild(div);
        });
        applyViewFilter();
    }

    function applyViewFilter() {
        const checkboxes = document.querySelectorAll('.filter-options input');
        const checkedValues = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.value));
        const items = document.querySelectorAll('.grid-item');
        items.forEach(item => {
            const val = parseInt(item.dataset.val);
            if (checkedValues.includes(val)) { item.classList.remove('hidden'); } else { item.classList.add('hidden'); }
        });
    }

    function getRank(myData, allData) {
        const keys = Object.keys(myData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        if (keys.length === 0) return "-";
        let scores = allData.map(student => {
            let score = 0;
            keys.forEach(k => {
                let val = parseInt(student[k]) || 0;
                if (val === 1 || val === 3) score++;
            });
            return { name: student['ì´ë¦„'], score: score };
        });
        let myScore = 0;
        keys.forEach(k => {
            let val = parseInt(tempChanges[k] !== undefined ? tempChanges[k] : myData[k]) || 0;
            if (val === 1 || val === 3) myScore++;
        });
        let myEntryIndex = scores.findIndex(s => s.name === myData['ì´ë¦„']);
        if(myEntryIndex !== -1) scores[myEntryIndex].score = myScore;
        scores.sort((a, b) => b.score - a.score);
        let rank = scores.findIndex(s => s.name === myData['ì´ë¦„']) + 1;
        return `${rank}ìœ„ / ${scores.length}ëª…`;
    }

    function updateTier(userData) {
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        let total = keys.length;
        let done = 0;
        keys.forEach(k => {
            let val = parseInt(userData[k]) || 0;
            if (val === 1 || val === 3) done++; 
        });
        let percent = total === 0 ? 0 : (done / total) * 100;
        let badge = document.getElementById('tier-badge');
        let tierName = "", tierClass = "", tierIcon = "";

        if (percent === 100) { tierName = "CHALLENGER"; tierClass = "tier-challenger"; tierIcon = "ğŸ‘‘"; }
        else if (percent >= 90) { tierName = "DIAMOND"; tierClass = "tier-diamond"; tierIcon = "ğŸ’"; }
        else if (percent >= 70) { tierName = "PLATINUM"; tierClass = "tier-platinum"; tierIcon = "ğŸ’ "; }
        else if (percent >= 50) { tierName = "GOLD"; tierClass = "tier-gold"; tierIcon = "ğŸ¥‡"; }
        else if (percent >= 30) { tierName = "SILVER"; tierClass = "tier-silver"; tierIcon = "ğŸ¥ˆ"; }
        else if (percent >= 10) { tierName = "BRONZE"; tierClass = "tier-bronze"; tierIcon = "ğŸ¥‰"; }
        else { tierName = "IRON"; tierClass = "tier-iron"; tierIcon = "ğŸ›¡ï¸"; }

        let rankText = getRank(userData, currentClassData);
        badge.className = `tier-badge ${tierClass}`;
        badge.innerHTML = `
            <div class="tier-row"><span class="tier-icon">${tierIcon}</span> <span class="tier-name">${tierName}</span></div>
            <div class="rank-text">í˜„ì¬ ìˆœìœ„ : ${rankText}</div>
            <div class="tier-progress-bg"><div class="tier-progress-fill" style="width:${percent}%"></div></div>
        `;
    }

    function getPattern() {
        const patternCanvas = document.createElement('canvas');
        const pCtx = patternCanvas.getContext('2d');
        patternCanvas.width = 10;
        patternCanvas.height = 10;
        pCtx.fillStyle = '#E8F5E9'; pCtx.fillRect(0,0,10,10);
        pCtx.strokeStyle = '#218c74'; pCtx.lineWidth = 2;
        pCtx.beginPath(); pCtx.moveTo(0, 10); pCtx.lineTo(10, 0); pCtx.stroke();
        return pCtx.createPattern(patternCanvas, 'repeat');
    }

    const centerTextPlugin = {
        id: 'centerText',
        beforeDraw: function(chart) {
            if (chart.config.type !== 'doughnut') return;
            var width = chart.width, height = chart.height, ctx = chart.ctx;
            ctx.restore();
            let data = chart.data.datasets[0].data;
            let total = data.reduce((a, b) => a + b, 0);
            let score = data[1] + data[3];
            let percent = total === 0 ? 0 : Math.round((score / total) * 100);
            var fontSize = (height / 114).toFixed(2);
            ctx.font = "bold " + fontSize + "em Pretendard";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "#191F28";
            var text = percent + "%", textX = Math.round((width - ctx.measureText(text).width) / 2), textY = height / 2;
            ctx.fillText(text, textX, textY);
            ctx.save();
        }
    };
    Chart.register(centerTextPlugin);

    function updateChart(userData) {
        const ctx = document.getElementById('progressChart').getContext('2d');
        let counts = [0, 0, 0, 0]; 
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            counts[val]++;
        });

        if (myChart) myChart.destroy();
        const bgColors = ['#F2F4F6', '#00A86B', '#E31A1A', getPattern()];

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ì•ˆí’ˆ', 'ë§ìŒ', 'í‹€ë¦¼', 'ê³ ì¹¨'],
                datasets: [{
                    data: counts,
                    backgroundColor: bgColors,
                    borderWidth: 2,
                    borderColor: 'white',
                    borderRadius: 20,
                    hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
        });
    }

    function analyzePerformance() {
        if (!currentClassData || currentClassData.length === 0) return;
        let myData = currentClassData.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
        let myStatus = {...myData, ...tempChanges}; 
        let questionStats = {};
        const keys = Object.keys(myData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        
        let participatedCount = 0;
        keys.forEach(key => {
            let correctCount = 0;
            let totalStudents = 0;
            currentClassData.forEach(student => {
                let val = parseInt(student[key]) || 0;
                if (val === 1) correctCount++; 
                totalStudents++;
            });
            let count1 = currentClassData.filter(s => parseInt(s[key]) === 1).length;
            questionStats[key] = totalStudents === 0 ? 0 : (count1 / totalStudents) * 100;
        });

        participatedCount = 0;
        currentClassData.forEach(s => {
            if(keys.some(k => parseInt(s[k]) > 0)) participatedCount++;
        });
        let participationRate = participatedCount / currentClassData.length;

        let regretList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 2 || s === 3; });
        let regretHtml = "";
        if (regretList.length > 0) {
            let maxRate = Math.max(...regretList.map(q => questionStats[q]));
            let topRegretQs = regretList.filter(q => questionStats[q] === maxRate);
            let qText = topRegretQs.join(', ');
            let rate = Math.round(maxRate);
            regretHtml = `<div class="analysis-box" style="border-left-color: #E31A1A;"><b>ğŸš¨ ì‹¤ìˆ˜ ì£¼ì˜!</b><br>${qText}ë²ˆ ë¬¸ì œëŠ” ì¹œêµ¬ë“¤ <b>${rate}%</b>ê°€ ë§í˜”ì–´ìš”. ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”!</div>`;
        } else {
            regretHtml = `<div class="analysis-box">ğŸ‘ ì‹¤ìˆ˜ ë°©ì–´ ì„±ê³µ!</div>`;
        }

        let proudList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 3; });
        let proudHtml = "";
        if (proudList.length > 0) {
            let minRate = Math.min(...proudList.map(q => questionStats[q]));
            let topProudQs = proudList.filter(q => questionStats[q] === minRate);
            let qText = topProudQs.join(', ');
            let rate = Math.round(minRate);
            proudHtml = `<div class="analysis-box" style="border-left-color: #00A86B;"><b>ğŸ† í‚¬ëŸ¬ ì •ë³µ!</b><br>ì •ë‹µë¥  <b>${rate}%</b>ì¸ ${qText}ë²ˆì„ ê³ ì³ëƒˆêµ°ìš”! ëŒ€ë‹¨í•©ë‹ˆë‹¤.</div>`;
        }

        let warningHtml = "";
        if (participationRate < 0.5) {
            warningHtml = `<div class="warning-box">âš ï¸ ì•„ì§ ì œì¶œí•œ ì¹œêµ¬ê°€ ì ì–´ì„œ(${participatedCount}ëª…) ë¶„ì„ì´ ë¶€ì •í™•í•  ìˆ˜ ìˆì–´ìš”.</div>`;
        }

        document.getElementById('analysis-content').innerHTML = regretHtml + (proudHtml || "") + warningHtml;
        document.getElementById('analysis-modal').style.display = 'flex';
    }

    function closeModal(e, id) {
        if (e.target === document.getElementById(id)) {
            document.getElementById(id).style.display = 'none';
        }
    }

    function saveData(exitMode = false) {
        const statusDiv = document.getElementById('save-status');
        const keysToSave = Object.keys(tempChanges);

        if (keysToSave.length === 0) {
            statusDiv.innerText = "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤";
            statusDiv.style.color = "var(--toss-text-gray)";
            if(exitMode) exitWithoutSave();
            return;
        }

        toggleLoader(true); 
        statusDiv.innerText = "ì €ì¥ ë° ì œì¶œ ì¤‘...";
        
        const badge = document.getElementById('tier-badge').innerText.split('\n')[0]; 

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: "saveBatch",
                sheetName: currentSheetName,
                rowIndex: currentUserRowIndex,
                changes: tempChanges,
                studentName: userCredentials.name,
                tierInfo: badge
            })
        })
        .then(res => res.json())
        .then(json => {
            toggleLoader(false); 
            if (json.status !== "success") {
                throw new Error(json.message || "ì €ì¥ ì‹¤íŒ¨");
            }
            
            statusDiv.innerText = "âœ… ì œì¶œ ì™„ë£Œ!";
            statusDiv.style.color = "#00A86B";
            tempChanges = {};
            setTimeout(() => { statusDiv.innerText = ""; }, 3000);
            
            if (exitMode) {
                exitWithoutSave();
            } else {
                loadGame(currentSheetName);
            }
        })
        .catch(err => {
            toggleLoader(false);
            console.error(err);
            statusDiv.innerText = "âŒ ì €ì¥ ì‹¤íŒ¨";
            statusDiv.style.color = "#E31A1A";
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n(ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”)");
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function logout() { userCredentials = {}; location.reload(); }
</script>

</body>
</html>
