// â˜…â˜…â˜… ì„ ìƒë‹˜ì˜ ë°°í¬ ID ì£¼ì†Œë¡œ ìœ ì§€í•˜ì„¸ìš” â˜…â˜…â˜…
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec"; 
    
    let userCredentials = { name: "", pw: "" };
    let currentSheetName = "";
    let currentUserRowIndex = -1;
    let tempChanges = {}; 

    const ICONS = ["âšª", "ðŸŸ¢", "ðŸ”´", "âœ…"]; 
    const CLASS_NAMES = ["status-0", "status-1", "status-2", "status-3"];

    function goToChapterSelect() {
        const name = document.getElementById('input-name').value.trim();
        const pw = document.getElementById('input-pw').value.trim();
        if(!name || !pw) { alert("ì´ë¦„ê³¼ ë¹„ë²ˆì„ ìž…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        
        userCredentials.name = name;
        userCredentials.pw = pw;
        document.getElementById('loader').style.display = 'block';

        fetch(GOOGLE_SCRIPT_URL + "?action=getChapters")
        .then(res => res.json())
        .then(chapters => {
            document.getElementById('loader').style.display = 'none';
            showScreen('screen-chapter');
            renderChapters(chapters);
        })
        .catch(err => {
            document.getElementById('loader').style.display = 'none';
            alert("ëª©ë¡ ë¡œë”© ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
        });
    }

    function renderChapters(chapters) {
        const list = document.getElementById('chapter-list');
        list.innerHTML = "";
        chapters.forEach(chap => {
            const btn = document.createElement('button');
            btn.className = 'chapter-btn';
            btn.innerText = "ðŸ“– " + chap;
            btn.onclick = () => loadGame(chap);
            list.appendChild(btn);
        });
    }

    function loadGame(sheetName) {
        currentSheetName = sheetName;
        document.getElementById('loader').style.display = 'block';
        
        // â˜… ìºì‹± ë°©ì§€ìš© íƒ€ìž„ìŠ¤íƒ¬í”„ ì¶”ê°€
        const timestamp = new Date().getTime(); 
        const requestUrl = GOOGLE_SCRIPT_URL + "?action=getData&sheetName=" + encodeURIComponent(sheetName) + "&t=" + timestamp;

        fetch(requestUrl)
        .then(res => res.json())
        .then(data => {
            document.getElementById('loader').style.display = 'none';
            // ë°ì´í„° ë¹„êµ ì‹œ Stringìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì•ˆì „í•˜ê²Œ ë¹„êµ
            const user = data.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
            
            if (user) {
                currentUserRowIndex = user['rowIndex'];
                showScreen('screen-game');
                document.getElementById('game-title').innerText = `${sheetName} (${user['ì´ë¦„']})`;
                renderGrid(user);
            } else {
                alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n(ë¹„ë²ˆ í™•ì¸ ë˜ëŠ” ì‹œíŠ¸ì— ì´ë¦„ì´ ìžˆëŠ”ì§€ í™•ì¸)");
                showScreen('screen-login');
            }
        })
        .catch(err => {
            document.getElementById('loader').style.display = 'none';
            alert("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
        });
    }

    function renderGrid(userData) {
        const gridBox = document.getElementById('grid-box');
        gridBox.innerHTML = "";
        tempChanges = {}; 

        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            const div = document.createElement('div');
            div.className = `grid-item ${CLASS_NAMES[val]}`;
            div.innerHTML = `<div class="q-num">${key}</div><div class="q-icon">${ICONS[val]}</div>`;

            div.onclick = function() {
                let current = (tempChanges[key] !== undefined) ? tempChanges[key] : val;
                let nextVal = (current + 1) % 4;
                
                div.className = `grid-item ${CLASS_NAMES[nextVal]}`;
                div.querySelector('.q-icon').innerText = ICONS[nextVal];
                tempChanges[key] = nextVal;
            };
            gridBox.appendChild(div);
        });
    }

    function saveData() {
        const statusDiv = document.getElementById('save-status');
        const keysToSave = Object.keys(tempChanges);

        if (keysToSave.length === 0) { statusDiv.innerText = "ë³€ê²½ì‚¬í•­ ì—†ìŒ"; return; }

        statusDiv.innerText = "ì €ìž¥ ì¤‘...";
        statusDiv.style.color = "orange";

        // â˜… [ìˆ˜ì •] no-cors ì œê±°. ì´ì œ ì§„ì§œ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ë¥¼ ì‘ë‹µë°›ìŠµë‹ˆë‹¤.
        let promises = keysToSave.map(colName => {
            return fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    sheetName: currentSheetName,
                    rowIndex: currentUserRowIndex,
                    colName: colName,
                    value: tempChanges[colName]
                })
            })
            .then(res => res.json())
            .then(json => {
                 if(json.status === 'error') {
                     throw new Error(json.message); // ì—ëŸ¬ ë°œìƒ ì‹œ catchë¡œ ì´ë™
                 }
            });
        });

        Promise.all(promises)
        .then(() => {
            statusDiv.innerText = "âœ… ì €ìž¥ ì™„ë£Œ!";
            statusDiv.style.color = "green";
            tempChanges = {};
            setTimeout(() => { statusDiv.innerText = ""; }, 2000);
        })
        .catch(err => {
            console.error(err);
            statusDiv.innerText = "âŒ ì €ìž¥ ì‹¤íŒ¨!";
            statusDiv.style.color = "red";
            alert("ì €ìž¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì´ìœ : " + err.message + "\n(Apps Scriptë¥¼ 'ìƒˆ ë²„ì „'ìœ¼ë¡œ ë°°í¬í–ˆëŠ”ì§€ ê¼­ í™•ì¸í•˜ì„¸ìš”!)");
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goBackToChapter() { showScreen('screen-chapter'); }
    function logout() { userCredentials = {}; location.reload(); }
