<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìˆ˜í•™ ì§„ë„í‘œ</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* =========================================
           ğŸ¨ [í† ìŠ¤ ìŠ¤íƒ€ì¼] ë””ìì¸ ë³€ìˆ˜ ì •ì˜
           ========================================= */
        :root {
            --toss-blue: #0064FF;       /* í† ìŠ¤ ì‹œê·¸ë‹ˆì²˜ ë¸”ë£¨ */
            --toss-bg: #F2F4F6;         /* í† ìŠ¤ ë°°ê²½ ì—°íšŒìƒ‰ */
            --toss-text-dark: #191F28;  /* ì§„í•œ ê¸€ì”¨ */
            --toss-text-gray: #8B95A1;  /* ì—°í•œ ê¸€ì”¨ */
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); /* ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì */
            --radius-L: 24px;           /* í° ë‘¥ê¸€ê¸° */
            --radius-M: 16px;           /* ì¤‘ê°„ ë‘¥ê¸€ê¸° */
            --radius-S: 12px;           /* ì‘ì€ ë‘¥ê¸€ê¸° */
        }

        body {
            font-family: "Pretendard Variable", Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, "Helvetica Neue", "Segoe UI", "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
            background-color: var(--toss-bg);
            margin: 0;
            padding: 20px;
            color: var(--toss-text-dark);
            line-height: 1.5;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ: í°ìƒ‰ ì¹´ë“œ í˜•íƒœ */
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px 24px; /* íŒ¨ë”©ì„ ì¢€ ë” ë„‰ë„‰í•˜ê²Œ */
            border-radius: var(--radius-L);
            box-shadow: var(--card-shadow);
        }

        h2, h3 {
            text-align: center;
            color: var(--toss-text-dark);
            font-weight: 700;
            margin-bottom: 24px;
            letter-spacing: -0.5px;
        }
        h2 { font-size: 24px; }
        h3 { font-size: 20px; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼: í† ìŠ¤ ë¸”ë£¨ ì ìš©, ëˆ„ë¥´ëŠ” íš¨ê³¼ ì¶”ê°€ */
        button {
            font-family: inherit;
            transition: all 0.2s ease;
        }
        button:active { transform: scale(0.96); /* ëˆ„ë¥´ë©´ ì‚´ì§ ì‘ì•„ì§ */ }

        button.primary, button.analyze {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: var(--radius-M);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }
        button.primary {
            background-color: var(--toss-blue);
            color: white;
        }
        button.primary:hover { background-color: #0050CC; } /* í˜¸ë²„ íš¨ê³¼ */
        
        button.analyze {
            background-color: #E8F3FF; /* ì•„ì£¼ ì—°í•œ ë¸”ë£¨ */
            color: var(--toss-blue);
        }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼: í…Œë‘ë¦¬ ì—†ì• ê³  ë°°ê²½ìƒ‰ìœ¼ë¡œ */
        input, select {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: none; /* í…Œë‘ë¦¬ ì œê±° */
            background-color: #F9FAFB; /* ì•„ì£¼ ì—°í•œ íšŒìƒ‰ ë°°ê²½ */
            border-radius: var(--radius-M);
            font-size: 17px;
            font-family: inherit;
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
            transition: 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--toss-blue); /* í¬ì»¤ìŠ¤ì‹œ íŒŒë€ í…Œë‘ë¦¬ */
            background-color: white;
        }

        .screen { display: none; flex-direction: column; gap: 10px; }
        .active { display: flex; }

        /* í‹°ì–´ ë°°ì§€: ì¹´ë“œ í˜•íƒœë¡œ ë³€ê²½ */
        .tier-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            padding: 20px;
            border-radius: var(--radius-L);
            font-weight: 700;
            color: white;
            font-size: 18px;
            box-shadow: var(--card-shadow); /* ê·¸ë¦¼ì ì¶”ê°€ */
            /* ë°°ê²½ìƒ‰ì€ JSì—ì„œ ê·¸ë¼ë°ì´ì…˜ìœ¼ë¡œ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤ */
        }
        .tier-icon { font-size: 32px; margin-right: 12px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }

        /* í‹°ì–´ë³„ ìƒ‰ìƒ (ê·¸ë¼ë°ì´ì…˜ ìœ ì§€) */
        .tier-iron { background: linear-gradient(135deg, #585858, #3a3a3a); }
        .tier-bronze { background: linear-gradient(135deg, #cd7f32, #a05a2c); }
        .tier-silver { background: linear-gradient(135deg, #c0c0c0, #909090); }
        .tier-gold { background: linear-gradient(135deg, #ffd700, #daa520); }
        .tier-platinum { background: linear-gradient(135deg, #00ced1, #008b8b); }
        .tier-diamond { background: linear-gradient(135deg, #b9f2ff, #00bfff); color: #005f99; }
        .tier-challenger { background: linear-gradient(135deg, #ff4e50, #f9d423); border: 3px solid gold; }

        /* í•„í„°: ì•Œì•½ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½ */
        .filter-options { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-label {
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            padding: 8px 12px;
            background: #F9FAFB;
            border-radius: 20px; /* ì•Œì•½ ëª¨ì–‘ */
            font-weight: 500;
            color: var(--toss-text-gray);
            transition: 0.2s;
        }
        /* ì²´í¬ë°•ìŠ¤ê°€ ì„ íƒë˜ì—ˆì„ ë•Œ ë¼ë²¨ ìŠ¤íƒ€ì¼ ë³€ê²½ (ì•¼ë§¤ ë°©ì‹ì´ì§€ë§Œ íš¨ê³¼ì ) */
        .filter-label:has(input:checked) {
            background-color: #E8F3FF;
            color: var(--toss-blue);
            font-weight: 700;
        }
        
        /* =========================================
           ğŸ§© ê·¸ë¦¬ë“œ ì•„ì´í…œ (ë¬¸ì œ ì¹¸) ë””ìì¸ í•µì‹¬
           ========================================= */
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 24px; }
        .grid-item {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: white;
            border-radius: var(--radius-M); /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            cursor: pointer;
            border: none; /* í…Œë‘ë¦¬ ì œê±° */
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* ì•„ì£¼ ì•½í•œ ê¸°ë³¸ ê·¸ë¦¼ì */
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); /* ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜ */
        }
        .grid-item:active { transform: scale(0.92); /* ëˆ„ë¥´ëŠ” ë§›! */ }
        .grid-item.hidden { display: none; }
        
        /* ìƒíƒœë³„ ìƒ‰ìƒ - íŒŒìŠ¤í…”í†¤ ë°°ê²½ + ì„ ëª…í•œ ì•„ì´ì½˜ */
        .status-0 { background-color: white; color: var(--toss-text-gray); } /* ì•ˆí’ˆ */
        .status-1 { background-color: #E3FCEF; color: #00A86B; box-shadow: inset 0 0 0 2px #00A86B; } /* ë§ìŒ (ë¯¼íŠ¸) */
        .status-2 { background-color: #FFEBEB; color: #E31A1A; box-shadow: inset 0 0 0 2px #E31A1A; } /* í‹€ë¦¼ (ì†Œí”„íŠ¸ ë ˆë“œ) */
        .status-3 { background-color: #E8F3FF; color: var(--toss-blue); box-shadow: inset 0 0 0 2px var(--toss-blue); } /* ê³ ì¹¨ (ì†Œí”„íŠ¸ ë¸”ë£¨) */

        .q-num { font-size: 13px; font-weight: 600; margin-bottom: 4px; opacity: 0.8; }
        .q-icon { font-size: 26px; line-height: 1; }
        
        /* ë¡œë”©, ì°¨íŠ¸, íŒì—… ìŠ¤íƒ€ì¼ ì •ë¦¬ */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--toss-blue); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .chart-container { width: 60%; margin: 0 auto 20px auto; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 28px; border-radius: var(--radius-L); width: 85%; max-width: 400px; text-align: left; box-shadow: var(--card-shadow); }
        .analysis-box { background: #F9FAFB; padding: 16px; border-radius: var(--radius-S); margin-bottom: 12px; border-left: 5px solid var(--toss-blue); color: var(--toss-text-dark); }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“š ìˆ˜í•™ ì§„ë„í‘œ</h2>
    <div id="loader" class="loader"></div>

    <div id="screen-login" class="screen active">
        <p style="text-align:center; color:var(--toss-text-gray); margin-bottom: 20px;">í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
        <input type="text" id="input-name" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">
        <input type="password" id="input-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì „í™”ë²ˆí˜¸ ë’¤ 4ìë¦¬)">
        <button class="primary" onclick="goToChapterSelect()">ë‚´ ì§„ë„í‘œ ë³´ê¸°</button>
    </div>

    <div id="screen-chapter" class="screen">
        <h3>í•™ìŠµí•  ë‹¨ì›ì„ ì„ íƒí•˜ì„¸ìš”</h3>
        <div style="margin-bottom:15px;">
            <select id="class-filter" onchange="filterChapters()">
                <option value="all">ì „ì²´ ìˆ˜ì—… ë³´ê¸°</option>
            </select>
        </div>
        <div id="chapter-list" style="display:flex; flex-direction:column; gap:10px;"></div>
        <button onclick="logout()" style="background-color:#F2F4F6; color:var(--toss-text-gray); margin-top:20px;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="screen-game" class="screen">
        <h3 id="game-title" style="text-align:center; margin:0 0 20px 0;"></h3>
        
        <div id="tier-badge" class="tier-badge tier-iron">
            <span class="tier-icon">ğŸ›¡ï¸</span> <span>IRON (0%)</span>
        </div>

        <div class="chart-container"><canvas id="progressChart"></canvas></div>

        <div class="filter-options">
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="0" hidden>âšª ì•ˆí’ˆ</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="1" hidden>ğŸŸ¢ ë§ìŒ</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="2" hidden>ğŸ”´ í‹€ë¦¼</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="3" hidden>âœ… ê³ ì¹¨</label>
        </div>
        
        <div class="grid-container" id="grid-box"></div>

        <div style="text-align:center; margin-top:20px;">
            <div id="save-status" style="height:20px; font-size:14px; font-weight:600; margin-bottom: 8px;"></div>
            
            <div style="display:flex; gap:10px;">
                <button class="analyze" onclick="analyzePerformance()" style="flex:1;">ğŸ¤– AI ë¶„ì„</button>
                <button class="primary" onclick="saveData()" style="flex:2;">ì €ì¥ ë° ì œì¶œ</button>
            </div>
            <button onclick="goBackToChapter()" style="background-color:transparent; color:var(--toss-text-gray); padding:12px; margin-top:10px; width:100%;">â† ë‹¤ë¥¸ ë‹¨ì› ë³´ê¸°</button>
        </div>
    </div>
</div>

<div id="analysis-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ“Š í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
        <div id="analysis-content"></div>
        <button onclick="document.getElementById('analysis-modal').style.display='none'" style="width:100%; padding:16px; background:#F2F4F6; color:var(--toss-text-dark); border:none; border-radius:var(--radius-M); margin-top:20px; font-weight:600;">ë‹«ê¸°</button>
    </div>
</div>

<script>
    // â˜…â˜…â˜… ì„ ìƒë‹˜ URL í™•ì¸ í•„ìš” â˜…â˜…â˜…
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec"; 
    
    // ... (ì´í•˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ ì—†ì´ ì „ì²´ í¬í•¨) ...
    let userCredentials = { name: "", pw: "" };
    let currentSheetName = "";
    let currentUserRowIndex = -1;
    let tempChanges = {}; 
    let allChapters = []; 
    let myChart = null;
    let currentClassData = [];

    const ICONS = ["âšª", "ğŸŸ¢", "ğŸ”´", "âœ…"]; 
    const CLASS_NAMES = ["status-0", "status-1", "status-2", "status-3"];

    const TIER_ICONS = {
        "CHALLENGER": "ğŸ‘‘", "DIAMOND": "ğŸ’", "PLATINUM": "ğŸ’ ",
        "GOLD": "ğŸ¥‡", "SILVER": "ğŸ¥ˆ", "BRONZE": "ğŸ¥‰", "IRON": "ğŸ›¡ï¸"
    };

    function goToChapterSelect() {
        const name = document.getElementById('input-name').value.trim();
        const pw = document.getElementById('input-pw').value.trim();
        if(!name || !pw) { alert("ì´ë¦„ê³¼ ë¹„ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        userCredentials.name = name;
        userCredentials.pw = pw;
        document.getElementById('loader').style.display = 'block';

        fetch(GOOGLE_SCRIPT_URL + "?action=getChapters")
        .then(res => res.json())
        .then(chapters => {
            document.getElementById('loader').style.display = 'none';
            allChapters = chapters; 
            showScreen('screen-chapter');
            setupClassFilter(chapters);
            filterChapters(); 
        })
        .catch(err => {
            document.getElementById('loader').style.display = 'none';
            alert("ëª©ë¡ ë¡œë”© ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
        });
    }

    function setupClassFilter(chapters) {
        const filter = document.getElementById('class-filter');
        filter.innerHTML = '<option value="all">ì „ì²´ ìˆ˜ì—… ë³´ê¸°</option>';
        const classes = new Set();
        chapters.forEach(chap => {
            const match = chap.match(/^\[(.*?)\]/);
            if (match) classes.add(match[0]); 
        });
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls;
            option.innerText = cls.replace(/[\[\]]/g, "") + " ìˆ˜ì—…"; 
            filter.appendChild(option);
        });
    }

    function filterChapters() {
        const selectedClass = document.getElementById('class-filter').value;
        const list = document.getElementById('chapter-list');
        list.innerHTML = "";
        allChapters.forEach(chap => {
            if (selectedClass === "all" || chap.startsWith(selectedClass)) {
                const btn = document.createElement('button');
                // [ìˆ˜ì •] ë‹¨ì› ì„ íƒ ë²„íŠ¼ë„ í† ìŠ¤ ìŠ¤íƒ€ì¼ ì ìš©
                btn.className = 'primary'; 
                btn.style.backgroundColor = 'white';
                btn.style.color = 'var(--toss-text-dark)';
                btn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                btn.innerText = "ğŸ“– " + chap.replace(selectedClass === "all" ? "" : selectedClass, "");
                btn.onclick = () => loadGame(chap);
                list.appendChild(btn);
            }
        });
    }

    function loadGame(sheetName) {
        currentSheetName = sheetName;
        document.getElementById('loader').style.display = 'block';
        
        const timestamp = new Date().getTime(); 
        const requestUrl = GOOGLE_SCRIPT_URL + "?action=getData&sheetName=" + encodeURIComponent(sheetName) + "&t=" + timestamp;

        fetch(requestUrl)
        .then(res => res.json())
        .then(data => {
            document.getElementById('loader').style.display = 'none';
            currentClassData = data;
            const user = data.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
            
            if (user) {
                currentUserRowIndex = user['rowIndex'];
                showScreen('screen-game');
                document.getElementById('game-title').innerText = `${sheetName} - ${user['ì´ë¦„']}`;
                renderGrid(user);
                updateChart(user);
                updateTier(user);
            } else {
                alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                showScreen('screen-login');
            }
        })
        .catch(err => {
            document.getElementById('loader').style.display = 'none';
            alert("ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
        });
    }

    function renderGrid(userData) {
        const gridBox = document.getElementById('grid-box');
        gridBox.innerHTML = "";
        tempChanges = {}; 
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            const div = document.createElement('button'); // [ìˆ˜ì •] ì ‘ê·¼ì„±ì„ ìœ„í•´ button íƒœê·¸ ì‚¬ìš©
            div.className = `grid-item ${CLASS_NAMES[val]}`;
            div.dataset.val = val;
            div.innerHTML = `<div class="q-num">${key}</div><div class="q-icon">${ICONS[val]}</div>`;

            div.onclick = function() {
                let current = (tempChanges[key] !== undefined) ? tempChanges[key] : val;
                let nextVal = (current + 1) % 4;
                div.className = `grid-item ${CLASS_NAMES[nextVal]}`;
                div.dataset.val = nextVal;
                div.querySelector('.q-icon').innerText = ICONS[nextVal];
                tempChanges[key] = nextVal;
                
                let previewData = {...userData, ...tempChanges};
                updateChart(previewData);
                updateTier(previewData);
                applyViewFilter();
            };
            gridBox.appendChild(div);
        });
        applyViewFilter();
    }

    function applyViewFilter() {
        const checkboxes = document.querySelectorAll('.filter-options input');
        const checkedValues = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.value));
        const items = document.querySelectorAll('.grid-item');
        items.forEach(item => {
            const val = parseInt(item.dataset.val);
            if (checkedValues.includes(val)) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }

    // [ìˆ˜ì •] ì•„ì´ì½˜ ì§ì ‘ ì£¼ì… ë°©ì‹ ìœ ì§€
    function updateTier(userData) {
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        let total = keys.length;
        let done = 0;
        keys.forEach(k => {
            let val = parseInt(userData[k]) || 0;
            if (val === 1 || val === 3) done++; 
        });
        let percent = total === 0 ? 0 : (done / total) * 100;
        let badge = document.getElementById('tier-badge');
        let tierName = "", tierClass = "", tierIcon = "";

        if (percent === 100) { tierName = "CHALLENGER"; tierClass = "tier-challenger"; tierIcon = "ğŸ‘‘"; }
        else if (percent >= 90) { tierName = "DIAMOND"; tierClass = "tier-diamond"; tierIcon = "ğŸ’"; }
        else if (percent >= 70) { tierName = "PLATINUM"; tierClass = "tier-platinum"; tierIcon = "ğŸ’ "; }
        else if (percent >= 50) { tierName = "GOLD"; tierClass = "tier-gold"; tierIcon = "ğŸ¥‡"; }
        else if (percent >= 30) { tierName = "SILVER"; tierClass = "tier-silver"; tierIcon = "ğŸ¥ˆ"; }
        else if (percent >= 10) { tierName = "BRONZE"; tierClass = "tier-bronze"; tierIcon = "ğŸ¥‰"; }
        else { tierName = "IRON"; tierClass = "tier-iron"; tierIcon = "ğŸ›¡ï¸"; }

        badge.className = `tier-badge ${tierClass}`;
        badge.innerHTML = `<span class="tier-icon">${tierIcon}</span> <span>${tierName} (${Math.round(percent)}%)</span>`;
    }

    function updateChart(userData) {
        const ctx = document.getElementById('progressChart').getContext('2d');
        let counts = [0, 0, 0, 0]; 
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            counts[val]++;
        });

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ì•ˆí’ˆ', 'ë§ìŒ', 'í‹€ë¦¼', 'ê³ ì¹¨'],
                datasets: [{
                    data: counts,
                    // [ìˆ˜ì •] ì°¨íŠ¸ ìƒ‰ìƒë„ íŒŒìŠ¤í…”í†¤ìœ¼ë¡œ ë³€ê²½
                    backgroundColor: ['#F2F4F6', '#00A86B', '#E31A1A', '#0064FF'],
                    borderWidth: 0 // í…Œë‘ë¦¬ ì œê±°
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                cutout: '65%', // ë„ë„› êµ¬ë© í¬ê¸° ì¡°ì ˆ
                plugins: { legend: { display: false } } 
            }
        });
    }

    function analyzePerformance() {
        if (!currentClassData || currentClassData.length === 0) return;
        let myData = currentClassData.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
        let myStatus = {...myData, ...tempChanges}; 
        let questionStats = {};
        const keys = Object.keys(myData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        
        keys.forEach(key => {
            let correctCount = 0;
            let totalStudents = 0;
            currentClassData.forEach(student => {
                let val = parseInt(student[key]) || 0;
                if (val === 1) correctCount++; 
                totalStudents++;
            });
            let count1 = currentClassData.filter(s => parseInt(s[key]) === 1).length;
            questionStats[key] = (count1 / totalStudents) * 100;
        });

        let regretList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 2 || s === 3; });
        regretList.sort((a, b) => questionStats[b] - questionStats[a]); 
        let regretItem = regretList.length > 0 ? regretList[0] : null;

        let proudList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 3; });
        proudList.sort((a, b) => questionStats[a] - questionStats[b]); 
        let proudItem = proudList.length > 0 ? proudList[0] : null;

        let html = "";
        if (regretItem) {
            let rate = Math.round(questionStats[regretItem]);
            html += `<div class="analysis-box" style="border-left-color: #E31A1A;"><b>ğŸš¨ ì‹¤ìˆ˜ ì£¼ì˜!</b><br>${regretItem}ë²ˆ ë¬¸ì œëŠ” ì¹œêµ¬ë“¤ <b>${rate}%</b>ê°€ ë§í˜”ì–´ìš”. ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”!</div>`;
        } else {
            html += `<div class="analysis-box">ğŸ‘ ì‹¤ìˆ˜ ë°©ì–´ ì„±ê³µ!</div>`;
        }

        if (proudItem) {
            let rate = Math.round(questionStats[proudItem]);
            html += `<div class="analysis-box" style="border-left-color: #00A86B;"><b>ğŸ† í‚¬ëŸ¬ ì •ë³µ!</b><br>ì •ë‹µë¥  <b>${rate}%</b>ì¸ ${proudItem}ë²ˆì„ ê³ ì³ëƒˆêµ°ìš”! ëŒ€ë‹¨í•©ë‹ˆë‹¤.</div>`;
        }

        document.getElementById('analysis-content').innerHTML = html;
        document.getElementById('analysis-modal').style.display = 'flex';
    }

    function closeModal(e) {
        if (e.target === document.getElementById('analysis-modal')) {
            document.getElementById('analysis-modal').style.display = 'none';
        }
    }

    function saveData() {
        const statusDiv = document.getElementById('save-status');
        const keysToSave = Object.keys(tempChanges);

        if (keysToSave.length === 0) {
            statusDiv.innerText = "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤";
            statusDiv.style.color = "var(--toss-text-gray)";
            return;
        }

        statusDiv.innerText = "ì €ì¥ ë° ì œì¶œ ì¤‘...";
        statusDiv.style.color = "var(--toss-blue)";

        const badge = document.getElementById('tier-badge').innerText;

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: "saveBatch",
                sheetName: currentSheetName,
                rowIndex: currentUserRowIndex,
                changes: tempChanges,
                studentName: userCredentials.name,
                tierInfo: badge
            })
        })
        .then(res => res.json())
        .then(json => {
            if (json.status !== "success") {
                throw new Error(json.message || "ì €ì¥ ì‹¤íŒ¨");
            }
            
            statusDiv.innerText = "âœ… ì œì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!";
            statusDiv.style.color = "#00A86B";
            tempChanges = {};
            setTimeout(() => { statusDiv.innerText = ""; }, 3000);
            loadGame(currentSheetName);
        })
        .catch(err => {
            console.error(err);
            statusDiv.innerText = "âŒ ì €ì¥ ì‹¤íŒ¨";
            statusDiv.style.color = "#E31A1A";
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n(ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”)");
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goBackToChapter() { showScreen('screen-chapter'); }
    function logout() { userCredentials = {}; location.reload(); }
</script>

</body>
</html>
