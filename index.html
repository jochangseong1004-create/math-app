<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìˆ˜í•™ ì§„ë„í‘œ</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --toss-blue: #0064FF;
            --toss-bg: #F2F4F6;
            --toss-text-dark: #191F28;
            --toss-text-gray: #8B95A1;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --radius-L: 24px;
            --radius-M: 16px;
        }

        body {
            font-family: "Pretendard Variable", Pretendard, -apple-system, sans-serif;
            background-color: var(--toss-bg);
            margin: 0;
            padding: 20px;
            color: var(--toss-text-dark);
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px 24px;
            border-radius: var(--radius-L);
            box-shadow: var(--card-shadow);
            min-height: 85vh;
            position: relative;
        }

        h2, h3 { text-align: center; color: var(--toss-text-dark); margin-bottom: 20px; font-weight: 700; }
        
        button { font-family: inherit; transition: all 0.1s ease; cursor: pointer; }
        button:active { transform: scale(0.96); }

        button.primary, button.analyze {
            width: 100%; padding: 16px; border: none; border-radius: var(--radius-M);
            font-size: 17px; font-weight: 600; margin-top: 12px;
        }
        button.primary { background-color: var(--toss-blue); color: white; }
        button.analyze { background-color: #E8F3FF; color: var(--toss-blue); }

        /* [ìˆ˜ì • 1] box-sizing ì¶”ê°€í•˜ì—¬ ë„ˆë¹„ ë¬¸ì œ í•´ê²° */
        input, select {
            width: 100%; padding: 16px; margin-bottom: 12px; border: none;
            background-color: #F9FAFB; border-radius: var(--radius-M);
            font-size: 17px; font-family: inherit;
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ ë„ˆë¹„ ê³„ì‚° */
        }
        input:focus, select:focus { outline: 2px solid var(--toss-blue); background: white; }

        .screen { display: none; flex-direction: column; }
        .active { display: flex; }

        /* í‹°ì–´ ë°°ì§€ */
        .tier-badge {
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px; padding: 16px; border-radius: var(--radius-L);
            font-weight: 700; color: white; font-size: 18px;
            box-shadow: var(--card-shadow);
            flex-direction: column; /* ìˆœìœ„ í‘œì‹œë¥¼ ìœ„í•´ ì„¸ë¡œ ì •ë ¬ */
            gap: 5px;
        }
        .tier-row { display: flex; align-items: center; }
        .tier-icon { font-size: 28px; margin-right: 10px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .rank-text { font-size: 14px; opacity: 0.9; font-weight: 500; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 10px; margin-top: 5px; }

        .tier-iron { background: linear-gradient(135deg, #585858, #3a3a3a); }
        .tier-bronze { background: linear-gradient(135deg, #cd7f32, #a05a2c); }
        .tier-silver { background: linear-gradient(135deg, #c0c0c0, #909090); }
        .tier-gold { background: linear-gradient(135deg, #ffd700, #daa520); }
        .tier-platinum { background: linear-gradient(135deg, #00ced1, #008b8b); }
        .tier-diamond { background: linear-gradient(135deg, #b9f2ff, #00bfff); color: #005f99; }
        .tier-challenger { background: linear-gradient(135deg, #ff4e50, #f9d423); border: 3px solid gold; }

        /* í•„í„° */
        .filter-options { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-label {
            font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px;
            padding: 8px 12px; background: #F9FAFB; border-radius: 20px;
            color: var(--toss-text-gray); transition: 0.2s; font-weight: 500;
        }
        .filter-label:has(input:checked) { background-color: #E8F3FF; color: var(--toss-blue); font-weight: 700; }

        /* ê·¸ë¦¬ë“œ */
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 24px; }
        .grid-item {
            aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: white; border-radius: var(--radius-M); border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.2s;
        }
        .grid-item.hidden { display: none; }
        
        .status-0 { background-color: white; color: var(--toss-text-gray); }
        .status-1 { background-color: #E3FCEF; color: #00A86B; box-shadow: inset 0 0 0 2px #00A86B; }
        .status-2 { background-color: #FFEBEB; color: #E31A1A; box-shadow: inset 0 0 0 2px #E31A1A; }
        .status-3 { 
            background-color: #f0fff4; 
            color: #218c74; 
            box-shadow: inset 0 0 0 2px #218c74;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(33, 140, 116, 0.1) 5px, rgba(33, 140, 116, 0.1) 10px);
        }

        .q-num { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .q-icon { font-size: 24px; }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ (ì¤‘ì•™ ì •ë ¬ ê°•í™”) */
        .loader-wrapper { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; border-radius: var(--radius-L); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--toss-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .chart-container { width: 65%; margin: 0 auto 20px auto; position: relative; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; padding: 28px; border-radius: var(--radius-L); width: 85%; max-width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .analysis-box { background: #F9FAFB; padding: 16px; border-radius: var(--radius-M); margin-bottom: 12px; border-left: 5px solid var(--toss-blue); text-align: left;}
        
        .modal-btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 20px; }
        .btn-yes { background-color: var(--toss-blue); color: white; padding: 14px; border: none; border-radius: 12px; font-weight: 600; }
        .btn-no { background-color: #FFEBEB; color: #E31A1A; padding: 14px; border: none; border-radius: 12px; font-weight: 600; }
        .btn-cancel { background-color: white; color: var(--toss-text-gray); padding: 14px; border: 1px solid #ddd; border-radius: 12px; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <div id="global-loader" class="loader-wrapper"><div class="loader"></div></div>

    <h2>ğŸ“š ìˆ˜í•™ ì§„ë„í‘œ</h2>

    <div id="screen-login" class="screen active">
        <p style="text-align:center; color:var(--toss-text-gray);">ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        <input type="text" id="input-name" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">
        <input type="password" id="input-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì „í™”ë²ˆí˜¸ ë’¤ 4ìë¦¬)">
        <button class="primary" onclick="goToChapterSelect()">ë‚´ ì§„ë„í‘œ ë³´ê¸°</button>
    </div>

    <div id="screen-chapter" class="screen">
        <h3>í•™ìŠµí•  ë‹¨ì›ì„ ì„ íƒí•˜ì„¸ìš”</h3>
        <div style="margin-bottom:15px;">
            <select id="class-filter" onchange="filterChapters()">
                <option value="all">ì „ì²´ ìˆ˜ì—… ë³´ê¸°</option>
            </select>
        </div>
        <div id="chapter-list" style="display:flex; flex-direction:column; gap:10px;"></div>
        <button onclick="logout()" style="background-color:#F2F4F6; color:var(--toss-text-gray); margin-top:20px; width:100%; padding:16px; border:none; border-radius:16px;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="screen-game" class="screen">
        <h3 id="game-title" style="text-align:center; margin:0 0 20px 0;"></h3>
        
        <div id="tier-badge" class="tier-badge tier-iron">
            <div class="tier-row"><span class="tier-icon">ğŸ›¡ï¸</span> <span>IRON (0%)</span></div>
            <div class="rank-text" id="rank-display">ìˆœìœ„ ê³„ì‚°ì¤‘...</div>
        </div>

        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>

        <div class="filter-options">
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="0" hidden>âšª ì•ˆí’ˆ</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="1" hidden>ğŸŸ¢ ë§ìŒ</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="2" hidden>ğŸ”´ í‹€ë¦¼</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="3" hidden>âœ… ê³ ì¹¨</label>
        </div>
        
        <div class="grid-container" id="grid-box"></div>

        <div style="text-align:center; margin-top:20px;">
            <div id="save-status" style="height:20px; font-size:14px; font-weight:600; margin-bottom:8px;"></div>
            <div style="display:flex; gap:10px;">
                <button class="analyze" onclick="analyzePerformance()" style="flex:1;">ğŸ¤– AI ë¶„ì„</button>
                <button class="primary" onclick="saveData()" style="flex:2;">ì €ì¥ ë° ì œì¶œ</button>
            </div>
            <button onclick="checkBackNavigation()" style="background-color:transparent; color:var(--toss-text-gray); padding:12px; margin-top:10px; width:100%; border:none;">â† ëª©ë¡ìœ¼ë¡œ</button>
        </div>
    </div>
</div>

<div id="analysis-modal" class="modal-overlay" onclick="closeModal(event, 'analysis-modal')">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ“Š í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
        <div id="analysis-content"></div>
        <button onclick="document.getElementById('analysis-modal').style.display='none'" style="width:100%; padding:16px; background:#F2F4F6; border:none; border-radius:16px; margin-top:20px; font-weight:600;">ë‹«ê¸°</button>
    </div>
</div>

<div id="exit-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-bottom:10px;">ì ê¹ë§Œìš”! ğŸ›‘</h3>
        <p style="color:var(--toss-text-gray); margin-bottom:20px;">
            ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤.<br>
            ì €ì¥í•˜ê³  ëª©ë¡ìœ¼ë¡œ ë‚˜ê°ˆê¹Œìš”?
        </p>
        <div class="modal-btn-group">
            <button class="btn-yes" onclick="saveAndExit()">ë„¤, ì €ì¥í•˜ê³  ë‚˜ê°ˆë˜ìš”</button>
            <button class="btn-no" onclick="exitWithoutSave()">ì•„ë‹ˆìš”, ê·¸ëƒ¥ ë‚˜ê°ˆë˜ìš”</button>
            <button class="btn-cancel" onclick="document.getElementById('exit-modal').style.display='none'">ì·¨ì†Œ (ê³„ì† í’€ê¸°)</button>
        </div>
    </div>
</div>

<script>
    // â˜…â˜…â˜… ì„ ìƒë‹˜ URL â˜…â˜…â˜…
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec"; 
    
    // ë¾±! ì†Œë¦¬
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playPopSound() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    // ë¡œë”© í† ê¸€ í•¨ìˆ˜
    function toggleLoader(show) {
        document.getElementById('global-loader').style.display = show ? 'flex' : 'none';
    }

    window.addEventListener('popstate', function(event) {
        if (document.getElementById('screen-game').classList.contains('active')) {
            checkBackNavigation(); 
        }
    });

    function checkBackNavigation() {
        if (Object.keys(tempChanges).length > 0) {
            history.pushState({page: 'game'}, document.title, "#game"); 
            document.getElementById('exit-modal').style.display = 'flex';
        } else {
            exitWithoutSave();
        }
    }

    function saveAndExit() {
        document.getElementById('exit-modal').style.display = 'none';
        saveData(true); 
    }

    function exitWithoutSave() {
        document.getElementById('exit-modal').style.display = 'none';
        tempChanges = {}; 
        currentSheetName = "";
        showScreen('screen-chapter');
        history.replaceState(null, null, ' ');
    }

    let userCredentials = { name: "", pw: "" };
    let currentSheetName = "";
    let currentUserRowIndex = -1;
    let tempChanges = {}; 
    let allChapters = []; 
    let myChart = null;
    let currentClassData = [];

    const ICONS = ["âšª", "ğŸŸ¢", "ğŸ”´", "âœ…"]; 
    const CLASS_NAMES = ["status-0", "status-1", "status-2", "status-3"];
    const TIER_ICONS = { "CHALLENGER": "ğŸ‘‘", "DIAMOND": "ğŸ’", "PLATINUM": "ğŸ’ ", "GOLD": "ğŸ¥‡", "SILVER": "ğŸ¥ˆ", "BRONZE": "ğŸ¥‰", "IRON": "ğŸ›¡ï¸" };

    function goToChapterSelect() {
        const name = document.getElementById('input-name').value.trim();
        const pw = document.getElementById('input-pw').value.trim();
        if(!name || !pw) { alert("ì´ë¦„ê³¼ ë¹„ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        userCredentials.name = name;
        userCredentials.pw = pw;
        
        toggleLoader(true); // ë¡œë”© ì‹œì‘

        fetch(GOOGLE_SCRIPT_URL + "?action=getChapters")
        .then(res => res.json())
        .then(chapters => {
            toggleLoader(false); // ë¡œë”© ë
            allChapters = chapters; 
            showScreen('screen-chapter');
            setupClassFilter(chapters);
            filterChapters(); 
        })
        .catch(err => {
            toggleLoader(false);
            alert("ëª©ë¡ ë¡œë”© ì‹¤íŒ¨.");
        });
    }

    function setupClassFilter(chapters) {
        const filter = document.getElementById('class-filter');
        filter.innerHTML = '<option value="all">ì „ì²´ ìˆ˜ì—… ë³´ê¸°</option>';
        const classes = new Set();
        chapters.forEach(chap => {
            const match = chap.match(/^\[(.*?)\]/);
            if (match) classes.add(match[0]); 
        });
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls;
            option.innerText = cls.replace(/[\[\]]/g, "") + " ìˆ˜ì—…"; 
            filter.appendChild(option);
        });
    }

    function filterChapters() {
        const selectedClass = document.getElementById('class-filter').value;
        const list = document.getElementById('chapter-list');
        list.innerHTML = "";
        allChapters.forEach(chap => {
            if (selectedClass === "all" || chap.startsWith(selectedClass)) {
                const btn = document.createElement('button');
                btn.className = 'primary'; 
                btn.style.backgroundColor = 'white';
                btn.style.color = '#191F28';
                btn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';
                btn.innerText = "ğŸ“– " + chap.replace(selectedClass === "all" ? "" : selectedClass, "");
                btn.onclick = () => loadGame(chap);
                list.appendChild(btn);
            }
        });
    }

    function loadGame(sheetName) {
        currentSheetName = sheetName;
        history.pushState({page: 'game'}, document.title, "#game");

        toggleLoader(true);
        const timestamp = new Date().getTime(); 
        const requestUrl = GOOGLE_SCRIPT_URL + "?action=getData&sheetName=" + encodeURIComponent(sheetName) + "&t=" + timestamp;

        fetch(requestUrl)
        .then(res => res.json())
        .then(data => {
            toggleLoader(false);
            currentClassData = data;
            const user = data.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
            
            if (user) {
                currentUserRowIndex = user['rowIndex'];
                showScreen('screen-game');
                document.getElementById('game-title').innerText = `${sheetName} - ${user['ì´ë¦„']}`;
                renderGrid(user);
                updateChart(user);
                updateTier(user);
            } else {
                alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                history.back(); 
            }
        })
        .catch(err => {
            toggleLoader(false);
            alert("ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
        });
    }

    function renderGrid(userData) {
        const gridBox = document.getElementById('grid-box');
        gridBox.innerHTML = "";
        tempChanges = {}; 
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            const div = document.createElement('button');
            div.className = `grid-item ${CLASS_NAMES[val]}`;
            div.dataset.val = val;
            div.innerHTML = `<div class="q-num">${key}</div><div class="q-icon">${ICONS[val]}</div>`;

            div.onclick = function() {
                playPopSound(); 
                
                let current = (tempChanges[key] !== undefined) ? tempChanges[key] : val;
                let nextVal = (current + 1) % 4;
                div.className = `grid-item ${CLASS_NAMES[nextVal]}`;
                div.dataset.val = nextVal;
                div.querySelector('.q-icon').innerText = ICONS[nextVal];
                tempChanges[key] = nextVal;
                
                let previewData = {...userData, ...tempChanges};
                updateChart(previewData);
                updateTier(previewData);
                applyViewFilter();
            };
            gridBox.appendChild(div);
        });
        applyViewFilter();
    }

    function applyViewFilter() {
        const checkboxes = document.querySelectorAll('.filter-options input');
        const checkedValues = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.value));
        const items = document.querySelectorAll('.grid-item');
        items.forEach(item => {
            const val = parseInt(item.dataset.val);
            if (checkedValues.includes(val)) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }

    // â˜…â˜…â˜… [ìˆ˜ì • 3] ìˆœìœ„ ê³„ì‚° ë¡œì§ ì¶”ê°€ â˜…â˜…â˜…
    function getRank(myData, allData) {
        // ë¬¸ì œ í‚¤ ëª©ë¡
        const keys = Object.keys(myData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        if (keys.length === 0) return "-";

        // ê° í•™ìƒë³„ ì ìˆ˜(ì™„ë£Œ ê°œìˆ˜) ê³„ì‚°
        let scores = allData.map(student => {
            let score = 0;
            keys.forEach(k => {
                let val = parseInt(student[k]) || 0;
                if (val === 1 || val === 3) score++;
            });
            return { name: student['ì´ë¦„'], score: score };
        });

        // ë‚´ ì ìˆ˜ (ì„ì‹œ ë³€ê²½ì‚¬í•­ í¬í•¨í•´ì„œ ê³„ì‚°í•´ì•¼ ì‹¤ì‹œê°„ ë°˜ì˜ë¨)
        let myScore = 0;
        keys.forEach(k => {
            let val = parseInt(tempChanges[k] !== undefined ? tempChanges[k] : myData[k]) || 0;
            if (val === 1 || val === 3) myScore++;
        });

        // ë‚´ ì ìˆ˜ë¡œ ë¦¬ìŠ¤íŠ¸ ê°±ì‹  (ë‹¤ë¥¸ í•™ìƒë“¤ì€ DBê¸°ì¤€, ë‚˜ëŠ” í˜„ì¬í™”ë©´ ê¸°ì¤€)
        let myEntryIndex = scores.findIndex(s => s.name === myData['ì´ë¦„']);
        if(myEntryIndex !== -1) scores[myEntryIndex].score = myScore;

        // ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        scores.sort((a, b) => b.score - a.score);

        // ë‚´ ìˆœìœ„ ì°¾ê¸°
        let rank = scores.findIndex(s => s.name === myData['ì´ë¦„']) + 1;
        let totalStudents = scores.length;

        return `${rank}ìœ„ / ${totalStudents}ëª…`;
    }

    function updateTier(userData) {
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        let total = keys.length;
        let done = 0;
        keys.forEach(k => {
            let val = parseInt(userData[k]) || 0;
            if (val === 1 || val === 3) done++; 
        });
        let percent = total === 0 ? 0 : (done / total) * 100;
        let badge = document.getElementById('tier-badge');
        let tierName = "", tierClass = "", tierIcon = "";

        if (percent === 100) { tierName = "CHALLENGER"; tierClass = "tier-challenger"; tierIcon = "ğŸ‘‘"; }
        else if (percent >= 90) { tierName = "DIAMOND"; tierClass = "tier-diamond"; tierIcon = "ğŸ’"; }
        else if (percent >= 70) { tierName = "PLATINUM"; tierClass = "tier-platinum"; tierIcon = "ğŸ’ "; }
        else if (percent >= 50) { tierName = "GOLD"; tierClass = "tier-gold"; tierIcon = "ğŸ¥‡"; }
        else if (percent >= 30) { tierName = "SILVER"; tierClass = "tier-silver"; tierIcon = "ğŸ¥ˆ"; }
        else if (percent >= 10) { tierName = "BRONZE"; tierClass = "tier-bronze"; tierIcon = "ğŸ¥‰"; }
        else { tierName = "IRON"; tierClass = "tier-iron"; tierIcon = "ğŸ›¡ï¸"; }

        // ìˆœìœ„ ê°€ì ¸ì˜¤ê¸°
        let rankText = getRank(userData, currentClassData);

        badge.className = `tier-badge ${tierClass}`;
        badge.innerHTML = `
            <div class="tier-row"><span class="tier-icon">${tierIcon}</span> <span>${tierName} (${Math.round(percent)}%)</span></div>
            <div class="rank-text">í˜„ì¬ ìˆœìœ„ : ${rankText}</div>
        `;
    }

    function getPattern() {
        const patternCanvas = document.createElement('canvas');
        const pCtx = patternCanvas.getContext('2d');
        patternCanvas.width = 10;
        patternCanvas.height = 10;
        pCtx.fillStyle = '#E8F5E9'; 
        pCtx.fillRect(0,0,10,10);
        pCtx.strokeStyle = '#218c74'; 
        pCtx.lineWidth = 2;
        pCtx.beginPath();
        pCtx.moveTo(0, 10);
        pCtx.lineTo(10, 0);
        pCtx.stroke();
        return pCtx.createPattern(patternCanvas, 'repeat');
    }

    const centerTextPlugin = {
        id: 'centerText',
        beforeDraw: function(chart) {
            if (chart.config.type !== 'doughnut') return;
            var width = chart.width, height = chart.height, ctx = chart.ctx;
            ctx.restore();
            let data = chart.data.datasets[0].data;
            let total = data.reduce((a, b) => a + b, 0);
            let score = data[1] + data[3];
            let percent = total === 0 ? 0 : Math.round((score / total) * 100);
            var fontSize = (height / 114).toFixed(2);
            ctx.font = "bold " + fontSize + "em Pretendard";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "#191F28";
            var text = percent + "%", textX = Math.round((width - ctx.measureText(text).width) / 2), textY = height / 2;
            ctx.fillText(text, textX, textY);
            ctx.save();
        }
    };
    Chart.register(centerTextPlugin);

    function updateChart(userData) {
        const ctx = document.getElementById('progressChart').getContext('2d');
        let counts = [0, 0, 0, 0]; 
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            counts[val]++;
        });

        if (myChart) myChart.destroy();
        const bgColors = ['#F2F4F6', '#00A86B', '#E31A1A', getPattern()];

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ì•ˆí’ˆ', 'ë§ìŒ', 'í‹€ë¦¼', 'ê³ ì¹¨'],
                datasets: [{
                    data: counts,
                    backgroundColor: bgColors,
                    borderWidth: 2,
                    borderColor: 'white',
                    borderRadius: 20,
                    hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
        });
    }

    function analyzePerformance() {
        if (!currentClassData || currentClassData.length === 0) return;
        let myData = currentClassData.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
        let myStatus = {...myData, ...tempChanges}; 
        let questionStats = {};
        const keys = Object.keys(myData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        keys.forEach(key => {
            let correctCount = 0;
            let totalStudents = 0;
            currentClassData.forEach(student => {
                let val = parseInt(student[key]) || 0;
                if (val === 1) correctCount++; 
                totalStudents++;
            });
            let count1 = currentClassData.filter(s => parseInt(s[key]) === 1).length;
            questionStats[key] = (count1 / totalStudents) * 100;
        });

        let regretList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 2 || s === 3; });
        regretList.sort((a, b) => questionStats[b] - questionStats[a]); 
        let regretItem = regretList.length > 0 ? regretList[0] : null;

        let proudList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 3; });
        proudList.sort((a, b) => questionStats[a] - questionStats[b]); 
        let proudItem = proudList.length > 0 ? proudList[0] : null;

        let html = "";
        if (regretItem) {
            let rate = Math.round(questionStats[regretItem]);
            html += `<div class="analysis-box" style="border-left-color: #E31A1A;"><b>ğŸš¨ ì‹¤ìˆ˜ ì£¼ì˜!</b><br>${regretItem}ë²ˆ ë¬¸ì œëŠ” ì¹œêµ¬ë“¤ <b>${rate}%</b>ê°€ ë§í˜”ì–´ìš”. ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”!</div>`;
        } else {
            html += `<div class="analysis-box">ğŸ‘ ì‹¤ìˆ˜ ë°©ì–´ ì„±ê³µ!</div>`;
        }

        if (proudItem) {
            let rate = Math.round(questionStats[proudItem]);
            html += `<div class="analysis-box" style="border-left-color: #00A86B;"><b>ğŸ† í‚¬ëŸ¬ ì •ë³µ!</b><br>ì •ë‹µë¥  <b>${rate}%</b>ì¸ ${proudItem}ë²ˆì„ ê³ ì³ëƒˆêµ°ìš”! ëŒ€ë‹¨í•©ë‹ˆë‹¤.</div>`;
        }

        document.getElementById('analysis-content').innerHTML = html;
        document.getElementById('analysis-modal').style.display = 'flex';
    }

    function closeModal(e, id) {
        if (e.target === document.getElementById(id)) {
            document.getElementById(id).style.display = 'none';
        }
    }

    function saveData(exitMode = false) {
        const statusDiv = document.getElementById('save-status');
        const keysToSave = Object.keys(tempChanges);

        if (keysToSave.length === 0) {
            statusDiv.innerText = "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤";
            statusDiv.style.color = "var(--toss-text-gray)";
            if(exitMode) exitWithoutSave();
            return;
        }

        // [ìˆ˜ì • 2] ì €ì¥ ì‹œì—ë„ ë¡œë”© ìŠ¤í”¼ë„ˆ ë„ì›€
        toggleLoader(true); 
        statusDiv.innerText = "ì €ì¥ ë° ì œì¶œ ì¤‘...";
        
        const badge = document.getElementById('tier-badge').innerText;

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: "saveBatch",
                sheetName: currentSheetName,
                rowIndex: currentUserRowIndex,
                changes: tempChanges,
                studentName: userCredentials.name,
                tierInfo: badge
            })
        })
        .then(res => res.json())
        .then(json => {
            toggleLoader(false); // ë¡œë”© ë
            if (json.status !== "success") {
                throw new Error(json.message || "ì €ì¥ ì‹¤íŒ¨");
            }
            
            statusDiv.innerText = "âœ… ì œì¶œ ì™„ë£Œ!";
            statusDiv.style.color = "#00A86B";
            tempChanges = {};
            setTimeout(() => { statusDiv.innerText = ""; }, 3000);
            
            if (exitMode) {
                exitWithoutSave();
            } else {
                loadGame(currentSheetName);
            }
        })
        .catch(err => {
            toggleLoader(false);
            console.error(err);
            statusDiv.innerText = "âŒ ì €ì¥ ì‹¤íŒ¨";
            statusDiv.style.color = "#E31A1A";
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n(ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”)");
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function logout() { userCredentials = {}; location.reload(); }
</script>

</body>
</html>
