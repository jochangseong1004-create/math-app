<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìˆ˜í•™ ì§„ë„í‘œ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f5f7; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button.primary { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button.primary:active { background-color: #0056b3; }
        input { width: 90%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; display: block; margin-left: auto; margin-right: auto;}

        /* í™”ë©´ ì „í™˜ìš© */
        .screen { display: none; flex-direction: column; gap: 10px; }
        .active { display: flex; }

        /* ë‹¨ì› ì„ íƒ ë²„íŠ¼ë“¤ */
        .chapter-btn { 
            padding: 15px; 
            background-color: white; 
            border: 2px solid #e0e0e0; 
            border-radius: 10px; 
            font-size: 16px; 
            font-weight: bold; 
            color: #333; 
            cursor: pointer; 
            transition: 0.2s; 
            text-align: left;
        }
        .chapter-btn:hover { border-color: #007bff; color: #007bff; background-color: #f0f8ff; }

        /* ê·¸ë¦¬ë“œ */
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .grid-item { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: white; border: 1px solid #e0e0e0; border-radius: 8px; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .grid-item:active { transform: scale(0.95); }
        
        .status-0 { background-color: white; border-color: #ddd; }
        .status-1 { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .status-2 { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .status-3 { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }

        .q-num { font-size: 12px; color: #666; margin-bottom: 2px; }
        .q-icon { font-size: 24px; line-height: 1; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .info-text { text-align: center; font-size: 13px; color: #555; background-color: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 15px; line-height: 1.6; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“š ìˆ˜í•™ ì§„ë„í‘œ</h2>
    <div id="loader" class="loader"></div>

    <div id="screen-login" class="screen active">
        <p style="text-align:center; color:gray;">ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        <input type="text" id="input-name" placeholder="ì´ë¦„ (ì˜ˆ: ì¡°ì°½ì„±)">
        <input type="password" id="input-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (ì˜ˆ: 3629)">
        <button class="primary" onclick="goToChapterSelect()">ë¡œê·¸ì¸</button>
    </div>

    <div id="screen-chapter" class="screen">
        <p style="text-align:center;">í•™ìŠµí•  ë‹¨ì›ì„ ì„ íƒí•˜ì„¸ìš”</p>
        <div id="chapter-list" style="display:flex; flex-direction:column; gap:10px;"></div>
        <button onclick="logout()" style="background-color:#6c757d; color:white; border:none; padding:10px; border-radius:8px; margin-top:20px;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="screen-game" class="screen">
        <h3 id="game-title" style="text-align:center; margin:0 0 10px 0;"></h3>
        
        <div class="info-text">
            í„°ì¹˜í•˜ë©´ ë°”ë€ë‹ˆë‹¤:<br>
            âšª(ì•ˆí’ˆ) â ğŸŸ¢(ë§ìŒ) â ğŸ”´(í‹€ë¦¼) â âœ…(ê³ ì¹¨)
        </div>
        
        <div class="grid-container" id="grid-box"></div>

        <div style="text-align:center; margin-top:10px;">
            <div id="save-status" style="height:20px; font-size:14px;"></div>
            <button class="primary" style="background-color: #28a745;" onclick="saveData()">ğŸ’¾ ë³€ê²½ì‚¬í•­ ì €ì¥í•˜ê¸°</button>
            <button onclick="goBackToChapter()" style="background-color:#6c757d; color:white; border:none; padding:10px; border-radius:8px; margin-top:10px; width:100%;">ğŸ”™ ë‹¨ì› ëª©ë¡ìœ¼ë¡œ</button>
        </div>
    </div>
</div>

<script>
    // â˜…â˜…â˜… ì•„ë˜ ì£¼ì†Œë¥¼ ì„ ìƒë‹˜ì˜ ë°°í¬ ID ì£¼ì†Œë¡œ ê¼­ ë°”ê¿”ì£¼ì„¸ìš”! â˜…â˜…â˜…
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec"; 
    
    let userCredentials = { name: "", pw: "" };
    let currentSheetName = "";
    let currentUserRowIndex = -1;
    let tempChanges = {}; 

    const ICONS = ["âšª", "ğŸŸ¢", "ğŸ”´", "âœ…"]; 
    const CLASS_NAMES = ["status-0", "status-1", "status-2", "status-3"];

    // 1. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ -> ë‹¨ì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function goToChapterSelect() {
        const name = document.getElementById('input-name').value.trim();
        const pw = document.getElementById('input-pw').value.trim();

        if(!name || !pw) { alert("ì´ë¦„ê³¼ ë¹„ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        
        userCredentials.name = name;
        userCredentials.pw = pw;

        document.getElementById('loader').style.display = 'block';

        // ì„œë²„ì— 'ë‹¨ì› ëª©ë¡' ìš”ì²­
        fetch(GOOGLE_SCRIPT_URL + "?action=getChapters")
        .then(res => res.json())
        .then(chapters => {
            document.getElementById('loader').style.display = 'none';
            showScreen('screen-chapter');
            renderChapters(chapters);
        })
        .catch(err => {
            document.getElementById('loader').style.display = 'none';
            alert("ì—°ê²° ì‹¤íŒ¨! ì¸í„°ë„·ì„ í™•ì¸í•˜ì„¸ìš”.");
        });
    }

    // ë‹¨ì› ëª©ë¡ ê·¸ë¦¬ê¸°
    function renderChapters(chapters) {
        const list = document.getElementById('chapter-list');
        list.innerHTML = "";
        chapters.forEach(chap => {
            const btn = document.createElement('button');
            btn.className = 'chapter-btn';
            btn.innerText = "ğŸ“– " + chap;
            btn.onclick = () => loadGame(chap);
            list.appendChild(btn);
        });
    }

    // 2. ë‹¨ì› ì„ íƒ ì‹œ -> í•´ë‹¹ ë‹¨ì› ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    function loadGame(sheetName) {
        currentSheetName = sheetName;
        document.getElementById('loader').style.display = 'block';
        
        // ì„œë²„ì— 'í•´ë‹¹ ë‹¨ì› ë°ì´í„°' ìš”ì²­
        fetch(GOOGLE_SCRIPT_URL + "?action=getData&sheetName=" + encodeURIComponent(sheetName))
        .then(res => res.json())
        .then(data => {
            document.getElementById('loader').style.display = 'none';
            
            // ì—¬ê¸°ì„œ ìœ ì € í™•ì¸
            const user = data.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
            
            if (user) {
                currentUserRowIndex = user['rowIndex'];
                showScreen('screen-game');
                document.getElementById('game-title').innerText = `${sheetName} (${user['ì´ë¦„']})`;
                renderGrid(user);
            } else {
                alert("ì´ ë‹¨ì›ì—ëŠ” í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.\n(í˜¹ì€ ë¹„ë²ˆì´ í‹€ë ¸ìŠµë‹ˆë‹¤)");
                showScreen('screen-login');
            }
        });
    }

    // ê·¸ë¦¬ë“œ ê·¸ë¦¬ê¸°
    function renderGrid(userData) {
        const gridBox = document.getElementById('grid-box');
        gridBox.innerHTML = "";
        tempChanges = {}; // ì´ˆê¸°í™”

        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            const div = document.createElement('div');
            div.className = `grid-item ${CLASS_NAMES[val]}`;
            div.innerHTML = `<div class="q-num">${key}</div><div class="q-icon">${ICONS[val]}</div>`;

            div.onclick = function() {
                let nextVal = (parseInt(tempChanges[key] !== undefined ? tempChanges[key] : val) + 1) % 4;
                
                div.className = `grid-item ${CLASS_NAMES[nextVal]}`;
                div.querySelector('.q-icon').innerText = ICONS[nextVal];
                tempChanges[key] = nextVal;
            };
            gridBox.appendChild(div);
        });
    }

    // 3. ì €ì¥í•˜ê¸°
    function saveData() {
        const statusDiv = document.getElementById('save-status');
        const keysToSave = Object.keys(tempChanges);

        if (keysToSave.length === 0) { statusDiv.innerText = "ë³€ê²½ì‚¬í•­ ì—†ìŒ"; return; }

        statusDiv.innerText = "ì €ì¥ ì¤‘...";
        statusDiv.style.color = "orange";

        let promises = keysToSave.map(colName => {
            return fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sheetName: currentSheetName, // ë‹¨ì› ì •ë³´ í¬í•¨
                    rowIndex: currentUserRowIndex,
                    colName: colName,
                    value: tempChanges[colName]
                })
            });
        });

        Promise.all(promises).then(() => {
            statusDiv.innerText = "âœ… ì €ì¥ ì™„ë£Œ!";
            statusDiv.style.color = "green";
            tempChanges = {};
            setTimeout(() => { statusDiv.innerText = ""; }, 2000);
        });
    }

    // í™”ë©´ ì „í™˜ í—¬í¼
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goBackToChapter() { showScreen('screen-chapter'); }
    function logout() { userCredentials = {}; location.reload(); }
</script>

</body>
</html>
