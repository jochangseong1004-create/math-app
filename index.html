<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìˆ˜í•™ ì§„ë„í‘œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f4f5f7; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        button.primary { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button.primary:active { background-color: #0056b3; }
        button.analyze { width: 100%; padding: 12px; background-color: #6f42c1; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        input, select { width: 90%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; display: block; margin-left: auto; margin-right: auto;}

        .screen { display: none; flex-direction: column; gap: 10px; }
        .active { display: flex; }

        /* í‹°ì–´ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .tier-badge { text-align: center; margin-bottom: 15px; padding: 10px; border-radius: 10px; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); transition: 0.3s; }
        .tier-iron { background: linear-gradient(45deg, #585858, #3a3a3a); }
        .tier-bronze { background: linear-gradient(45deg, #cd7f32, #a05a2c); }
        .tier-silver { background: linear-gradient(45deg, #c0c0c0, #909090); }
        .tier-gold { background: linear-gradient(45deg, #ffd700, #daa520); }
        .tier-platinum { background: linear-gradient(45deg, #00ced1, #008b8b); }
        .tier-diamond { background: linear-gradient(45deg, #b9f2ff, #00bfff); color: #005f99; text-shadow: none; }
        .tier-challenger { background: linear-gradient(45deg, #ff4e50, #f9d423); border: 2px solid gold; box-shadow: 0 0 10px gold; }

        /* í•„í„° ìŠ¤íƒ€ì¼ */
        .filter-options { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-label { font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 4px; user-select: none; }
        
        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; }
        .grid-item { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: white; border: 1px solid #e0e0e0; border-radius: 8px; cursor: pointer; }
        .grid-item.hidden { display: none; } /* í•„í„°ë§ìš© */
        
        .status-0 { background-color: white; border-color: #ddd; }
        .status-1 { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .status-2 { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .status-3 { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }

        .q-num { font-size: 12px; color: #666; margin-bottom: 2px; }
        .q-icon { font-size: 24px; line-height: 1; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .chart-container { width: 50%; margin: 0 auto 10px auto; }
        
        /* ë¶„ì„ íŒì—… */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 400px; text-align: left; }
        .analysis-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #007bff; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“š ìˆ˜í•™ ì§„ë„í‘œ</h2>
    <div id="loader" class="loader"></div>

    <div id="screen-login" class="screen active">
        <p style="text-align:center; color:gray;">ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
        <input type="text" id="input-name" placeholder="ì´ë¦„">
        <input type="password" id="input-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="primary" onclick="goToChapterSelect()">ë¡œê·¸ì¸</button>
    </div>

    <div id="screen-chapter" class="screen">
        <p style="text-align:center;">ìˆ˜ì—…ì„ ì„ íƒí•˜ì„¸ìš”</p>
        <div style="text-align:center; margin-bottom:15px;">
            <select id="class-filter" onchange="filterChapters()">
                <option value="all">ì „ì²´ ìˆ˜ì—… ë³´ê¸°</option>
            </select>
        </div>
        <div id="chapter-list" style="display:flex; flex-direction:column; gap:10px;"></div>
        <button onclick="logout()" style="background-color:#6c757d; color:white; border:none; padding:10px; border-radius:8px; margin-top:20px;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div id="screen-game" class="screen">
        <h3 id="game-title" style="text-align:center; margin:0 0 10px 0;"></h3>
        
        <div id="tier-badge" class="tier-badge tier-iron">Tier: Iron</div>

        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>

        <div class="filter-options">
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="0">âšªì•ˆí’ˆ</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="1">ğŸŸ¢ë§ìŒ</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="2">ğŸ”´í‹€ë¦¼</label>
            <label class="filter-label"><input type="checkbox" checked onchange="applyViewFilter()" value="3">âœ…ê³ ì¹¨</label>
        </div>
        
        <div class="grid-container" id="grid-box"></div>

        <div style="text-align:center; margin-top:10px;">
            <div id="save-status" style="height:20px; font-size:14px;"></div>
            <button class="analyze" onclick="analyzePerformance()">ğŸ¤– AI ë¶„ì„ ë¦¬í¬íŠ¸</button>
            <button class="primary" style="background-color: #28a745;" onclick="saveData()">ğŸ’¾ ì €ì¥í•˜ê¸° (ì•Œë¦¼ ì „ì†¡)</button>
            <button onclick="goBackToChapter()" style="background-color:#6c757d; color:white; border:none; padding:10px; border-radius:8px; margin-top:10px; width:100%;">ğŸ”™ ëª©ë¡ìœ¼ë¡œ</button>
        </div>
    </div>
</div>

<div id="analysis-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <h3 style="margin-top:0;">ğŸ“Š í•™ìŠµ ë¶„ì„</h3>
        <div id="analysis-content"></div>
        <button onclick="document.getElementById('analysis-modal').style.display='none'" style="width:100%; padding:10px; background:#6c757d; color:white; border:none; border-radius:8px; margin-top:10px;">ë‹«ê¸°</button>
    </div>
</div>

<script>
    // â˜…â˜…â˜… ì„ ìƒë‹˜ì˜ ë°°í¬ ID ì£¼ì†Œë¡œ ë³€ê²½í•˜ì„¸ìš”! â˜…â˜…â˜…
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDXsi0z7BzBF1BaeVHj1YcTpvxCKWWXHPXbUP9ohWPKl6SxIA3HgEolkcwtf15c5Fz/exec"; 
    
    let userCredentials = { name: "", pw: "" };
    let currentSheetName = "";
    let currentUserRowIndex = -1;
    let tempChanges = {}; 
    let allChapters = []; 
    let myChart = null;
    let currentClassData = [];
    let currentUserData = {}; // í˜„ì¬ ìœ ì € ë°ì´í„°(ì„ì‹œ í¬í•¨)

    const ICONS = ["âšª", "ğŸŸ¢", "ğŸ”´", "âœ…"]; 
    const CLASS_NAMES = ["status-0", "status-1", "status-2", "status-3"];

    function goToChapterSelect() {
        const name = document.getElementById('input-name').value.trim();
        const pw = document.getElementById('input-pw').value.trim();
        if(!name || !pw) { alert("ì´ë¦„ê³¼ ë¹„ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        
        userCredentials.name = name;
        userCredentials.pw = pw;
        document.getElementById('loader').style.display = 'block';

        fetch(GOOGLE_SCRIPT_URL + "?action=getChapters")
        .then(res => res.json())
        .then(chapters => {
            document.getElementById('loader').style.display = 'none';
            allChapters = chapters; 
            showScreen('screen-chapter');
            setupClassFilter(chapters);
            filterChapters(); 
        })
        .catch(err => {
            document.getElementById('loader').style.display = 'none';
            alert("ëª©ë¡ ë¡œë”© ì‹¤íŒ¨.");
        });
    }

    function setupClassFilter(chapters) {
        const filter = document.getElementById('class-filter');
        filter.innerHTML = '<option value="all">ì „ì²´ ìˆ˜ì—… ë³´ê¸°</option>';
        const classes = new Set();
        chapters.forEach(chap => {
            const match = chap.match(/^\[(.*?)\]/);
            if (match) classes.add(match[0]); 
        });
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls;
            option.innerText = cls.replace(/[\[\]]/g, "") + " ìˆ˜ì—…"; 
            filter.appendChild(option);
        });
    }

    function filterChapters() {
        const selectedClass = document.getElementById('class-filter').value;
        const list = document.getElementById('chapter-list');
        list.innerHTML = "";
        allChapters.forEach(chap => {
            if (selectedClass === "all" || chap.startsWith(selectedClass)) {
                const btn = document.createElement('button');
                btn.className = 'chapter-btn';
                btn.innerText = "ğŸ“– " + chap.replace(selectedClass === "all" ? "" : selectedClass, "");
                btn.onclick = () => loadGame(chap);
                list.appendChild(btn);
            }
        });
    }

    function loadGame(sheetName) {
        currentSheetName = sheetName;
        document.getElementById('loader').style.display = 'block';
        
        const timestamp = new Date().getTime(); 
        const requestUrl = GOOGLE_SCRIPT_URL + "?action=getData&sheetName=" + encodeURIComponent(sheetName) + "&t=" + timestamp;

        fetch(requestUrl)
        .then(res => res.json())
        .then(data => {
            document.getElementById('loader').style.display = 'none';
            currentClassData = data;

            const user = data.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
            
            if (user) {
                currentUserRowIndex = user['rowIndex'];
                currentUserData = user; // ì €ì¥
                showScreen('screen-game');
                document.getElementById('game-title').innerText = `${sheetName} - ${user['ì´ë¦„']}`;
                renderGrid(user);
                updateChart(user);
                updateTier(user); // í‹°ì–´ ì—…ë°ì´íŠ¸
            } else {
                alert("í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                showScreen('screen-login');
            }
        })
        .catch(err => {
            document.getElementById('loader').style.display = 'none';
            alert("ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
        });
    }

    function renderGrid(userData) {
        const gridBox = document.getElementById('grid-box');
        gridBox.innerHTML = "";
        tempChanges = {}; 

        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            const div = document.createElement('div');
            div.className = `grid-item ${CLASS_NAMES[val]}`;
            div.dataset.val = val; // í•„í„°ë§ìš©
            div.innerHTML = `<div class="q-num">${key}</div><div class="q-icon">${ICONS[val]}</div>`;

            div.onclick = function() {
                let current = (tempChanges[key] !== undefined) ? tempChanges[key] : val;
                let nextVal = (current + 1) % 4;
                
                div.className = `grid-item ${CLASS_NAMES[nextVal]}`;
                div.dataset.val = nextVal;
                div.querySelector('.q-icon').innerText = ICONS[nextVal];
                tempChanges[key] = nextVal;
                
                // ì‹¤ì‹œê°„ ì°¨íŠ¸/í‹°ì–´ ë°˜ì˜
                let previewData = {...userData, ...tempChanges};
                updateChart(previewData);
                updateTier(previewData);
                applyViewFilter(); // í•„í„° ì¬ì ìš©
            };
            gridBox.appendChild(div);
        });
        applyViewFilter();
    }

    // â˜… ë³´ê¸° í•„í„° ì ìš©
    function applyViewFilter() {
        const checkboxes = document.querySelectorAll('.filter-options input');
        const checkedValues = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.value));
        
        const items = document.querySelectorAll('.grid-item');
        items.forEach(item => {
            const val = parseInt(item.dataset.val);
            if (checkedValues.includes(val)) {
                item.classList.remove('hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }

    // â˜… í‹°ì–´ ê³„ì‚° ë° í‘œì‹œ
    function updateTier(userData) {
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        let total = keys.length;
        let done = 0;
        
        keys.forEach(k => {
            let val = parseInt(userData[k]) || 0;
            if (val === 1 || val === 3) done++; // ë§ìŒ(1) or ê³ ì¹¨(3) ì¸ì •
        });

        let percent = total === 0 ? 0 : (done / total) * 100;
        let badge = document.getElementById('tier-badge');
        let tierName = "";
        let tierClass = "";

        if (percent === 100) { tierName = "CHALLENGER"; tierClass = "tier-challenger"; }
        else if (percent >= 90) { tierName = "DIAMOND"; tierClass = "tier-diamond"; }
        else if (percent >= 70) { tierName = "PLATINUM"; tierClass = "tier-platinum"; }
        else if (percent >= 50) { tierName = "GOLD"; tierClass = "tier-gold"; }
        else if (percent >= 30) { tierName = "SILVER"; tierClass = "tier-silver"; }
        else if (percent >= 10) { tierName = "BRONZE"; tierClass = "tier-bronze"; }
        else { tierName = "IRON"; tierClass = "tier-iron"; }

        badge.className = `tier-badge ${tierClass}`;
        badge.innerText = `${tierName} (${Math.round(percent)}%)`;
    }

    function updateChart(userData) {
        const ctx = document.getElementById('progressChart').getContext('2d');
        let counts = [0, 0, 0, 0]; 
        const keys = Object.keys(userData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        keys.forEach(key => {
            const val = parseInt(userData[key]) || 0;
            counts[val]++;
        });

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ì•ˆí’ˆ', 'ë§ìŒ', 'í‹€ë¦¼', 'ê³ ì¹¨'],
                datasets: [{
                    data: counts,
                    backgroundColor: ['#f0f0f0', '#28a745', '#dc3545', '#17a2b8'],
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function analyzePerformance() {
        if (!currentClassData || currentClassData.length === 0) return;
        let myData = currentClassData.find(row => String(row['ì´ë¦„']) === userCredentials.name && String(row['ë¹„ë²ˆ']) === userCredentials.pw);
        let myStatus = {...myData, ...tempChanges}; 
        let questionStats = {};
        const keys = Object.keys(myData).filter(k => k !== 'ì´ë¦„' && k !== 'ë¹„ë²ˆ' && k !== 'rowIndex');
        
        keys.forEach(key => {
            let correctCount = 0;
            let totalStudents = 0;
            currentClassData.forEach(student => {
                let val = parseInt(student[key]) || 0;
                if (val === 1) correctCount++; 
                totalStudents++;
            });
            let count1 = currentClassData.filter(s => parseInt(s[key]) === 1).length;
            questionStats[key] = (count1 / totalStudents) * 100;
        });

        let regretList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 2 || s === 3; });
        regretList.sort((a, b) => questionStats[b] - questionStats[a]); 
        let regretItem = regretList.length > 0 ? regretList[0] : null;

        let proudList = keys.filter(k => { let s = parseInt(myStatus[k]) || 0; return s === 3; });
        proudList.sort((a, b) => questionStats[a] - questionStats[b]); 
        let proudItem = proudList.length > 0 ? proudList[0] : null;

        let html = "";
        if (regretItem) {
            let rate = Math.round(questionStats[regretItem]);
            html += `<div class="analysis-box" style="border-left-color: #dc3545;"><b>ğŸš¨ ì‹¤ìˆ˜ ì£¼ì˜!</b><br>${regretItem}ë²ˆ ë¬¸ì œëŠ” ì¹œêµ¬ë“¤ <b>${rate}%</b>ê°€ ë§í˜”ì–´ìš”. ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”!</div>`;
        } else {
            html += `<div class="analysis-box">ğŸ‘ ì‹¤ìˆ˜ ë°©ì–´ ì„±ê³µ!</div>`;
        }

        if (proudItem) {
            let rate = Math.round(questionStats[proudItem]);
            html += `<div class="analysis-box" style="border-left-color: #28a745;"><b>ğŸ† í‚¬ëŸ¬ ì •ë³µ!</b><br>ì •ë‹µë¥  <b>${rate}%</b>ì¸ ${proudItem}ë²ˆì„ ê³ ì³ëƒˆêµ°ìš”! ëŒ€ë‹¨í•©ë‹ˆë‹¤.</div>`;
        }

        document.getElementById('analysis-content').innerHTML = html;
        document.getElementById('analysis-modal').style.display = 'flex';
    }

    function closeModal(e) {
        if (e.target === document.getElementById('analysis-modal')) {
            document.getElementById('analysis-modal').style.display = 'none';
        }
    }

    function saveData() {
        const statusDiv = document.getElementById('save-status');
        const keysToSave = Object.keys(tempChanges);
        if (keysToSave.length === 0) { statusDiv.innerText = "ë³€ê²½ì‚¬í•­ ì—†ìŒ"; return; }

        statusDiv.innerText = "ì €ì¥ ë° ì•Œë¦¼ ì „ì†¡ ì¤‘...";
        statusDiv.style.color = "orange";

        // â˜… ì•Œë¦¼ì— ë³´ë‚¼ ì •ë³´ ì¶”ê°€ (í‹°ì–´, ì§„í–‰ë¥ )
        let badge = document.getElementById('tier-badge').innerText;
        
        let promises = keysToSave.map(colName => {
            return fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    sheetName: currentSheetName,
                    rowIndex: currentUserRowIndex,
                    colName: colName,
                    value: tempChanges[colName],
                    // â˜… ì•Œë¦¼ìš© ì¶”ê°€ ë°ì´í„°
                    studentName: userCredentials.name,
                    tierInfo: badge,
                    isLast: colName === keysToSave[keysToSave.length-1] // ë§ˆì§€ë§‰ ìš”ì²­ì¼ ë•Œë§Œ ì•Œë¦¼ ë³´ë‚´ê¸° ìœ„í•¨
                })
            })
            .then(res => res.json())
            .then(json => { if(json.status === 'error') throw new Error(json.message); });
        });

        Promise.all(promises)
        .then(() => {
            statusDiv.innerText = "âœ… ì €ì¥ & ì•Œë¦¼ ì™„ë£Œ!";
            statusDiv.style.color = "green";
            tempChanges = {};
            setTimeout(() => { statusDiv.innerText = ""; }, 2000);
            loadGame(currentSheetName);
        })
        .catch(err => {
            statusDiv.innerText = "âŒ ì €ì¥ ì‹¤íŒ¨!";
            statusDiv.style.color = "red";
            alert("ì €ì¥ ì‹¤íŒ¨. ì•±ì„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
        });
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goBackToChapter() { showScreen('screen-chapter'); }
    function logout() { userCredentials = {}; location.reload(); }
</script>

</body>
</html>
